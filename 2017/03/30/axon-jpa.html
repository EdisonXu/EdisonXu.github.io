<!DOCTYPE html><html lang="zh"><head><meta http-equiv="refresh" content="0;url=http://edisonxu.com/2017/03/30/axon-jpa.html"><meta charset="utf-8"><title>CQRS和Event Sourcing系列（四）： Axon使用Jpa存储Aggregate状态 | Edison Xu&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="上一篇里，介绍了Axon的基本概念，并且做了一个最简单的hello例子。本篇将更进一步，完成两个小目标：  集成SpringBoot； 使用Standard Repository来存储Aggregate的最新状态。   1. 更新Maven依赖干几件事："><meta name="keywords" content="CQRS,axon,DDD,eventsourcing"><meta property="og:type" content="article"><meta property="og:title" content="CQRS和Event Sourcing系列（四）： Axon使用Jpa存储Aggregate状态"><meta property="og:url" content="http://edisonxu.org/2017/03/30/axon-jpa.html"><meta property="og:site_name" content="Edison Xu&#39;s Blog"><meta property="og:description" content="上一篇里，介绍了Axon的基本概念，并且做了一个最简单的hello例子。本篇将更进一步，完成两个小目标：  集成SpringBoot； 使用Standard Repository来存储Aggregate的最新状态。   1. 更新Maven依赖干几件事："><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2018-02-23T02:19:15.402Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="CQRS和Event Sourcing系列（四）： Axon使用Jpa存储Aggregate状态"><meta name="twitter:description" content="上一篇里，介绍了Axon的基本概念，并且做了一个最简单的hello例子。本篇将更进一步，完成两个小目标：  集成SpringBoot； 使用Standard Repository来存储Aggregate的最新状态。   1. 更新Maven依赖干几件事："><link rel="alternate" href="/atom.xml" title="Edison Xu&#39;s Blog" type="application/atom+xml"><link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/vendor/open-sans/styles.css"><link rel="stylesheet" href="/vendor/source-code-pro/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/vendor/jquery/2.1.3/jquery.min.js"></script><link rel="stylesheet" href="/vendor/lightgallery/css/lightgallery.min.css"></head><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><i class="logo"></i> <span class="site-title">Edison Xu&#39;s Blog</span></a><nav id="main-nav"> <a class="main-nav-link" href="/.">主页</a> <a class="main-nav-link" href="/archives">目录</a> <a class="main-nav-link" href="http://blog.csdn.net/xeseo">旧站</a> <a class="main-nav-link" href="/about">关于我</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"> <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/e8022ebe2f6f01924ccded8d4db8b9fa"><i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form class="search-form"> <input type="text" class="ins-search-input search-form-input" placeholder="搜索"> <button type="submit" class="search-form-submit"></button></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"> <input type="text" class="ins-search-input" placeholder="想要查找什么..."><span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script></div></div></div><div id="main-nav-mobile" class="header-sub header-inner"><table class="menu outer"><tr><td><a class="main-nav-link" href="/.">主页</a></td><td><a class="main-nav-link" href="/archives">目录</a></td><td><a class="main-nav-link" href="http://blog.csdn.net/xeseo">旧站</a></td><td><a class="main-nav-link" href="/about">关于我</a></td><td><div class="search-form"> <input type="text" class="ins-search-input search-form-input" placeholder="搜索"></div></td></tr></table></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"> <img id="avatar" src="https://www.gravatar.com/avatar/e8022ebe2f6f01924ccded8d4db8b9fa?s=128"><h2 id="name">Edison Xu</h2><h3 id="title">懂得前端和移动，设计过架构，做过管理，也搞过自动化和运维，明白各种测试，知晓处理大数据。保持危机感和谦逊，方能更进一步</h3><span id="location"><i class="fa fa-map-marker"></i> 中国 - 上海</span> <a id="follow" target="_blank" href="http://edisonxu.com/about">关注我</a></div><div class="article-info profile-block"><div class="article-info-block"> 16 <span>文章</span></div><div class="article-info-block"> 15 <span>标签</span></div></div><div class="profile-block social-links"><table><tr><td><a href="https://github.com/EdisonXu" target="_blank" title="github" class="tooltip"><i class="fa fa-github"></i></a></td><td><a href="mailto:edisonxu@outlook.com" target="_blank" title="envelope" class="tooltip"><i class="fa fa-envelope"></i></a></td><td><a href="/css/images/myweixin.jpg" target="_blank" title="weixin" class="tooltip"><i class="fa fa-weixin"></i></a></td><td><a href="/atom.xml" target="_blank" title="rss" class="tooltip"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-axon-jpa" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name"> CQRS和Event Sourcing系列（四）： Axon使用Jpa存储Aggregate状态</h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2017/03/30/axon-jpa.html"><time datetime="2017-03-30T07:52:23.000Z" itemprop="datePublished">2017-03-30</time></a></div><i class="fa fa-tag"></i> <a class="tag-link" href="/tags/CQRS/">CQRS</a>, <a class="tag-link" href="/tags/DDD/">DDD</a>, <a class="tag-link" href="/tags/axon/">axon</a>, <a class="tag-link" href="/tags/eventsourcing/">eventsourcing</a><span id="busuanzi_container_site_pv" style="display:none;float:right"><i class="fa fa-eye" aria-hidden="true" style="margin-right:5px"></i><span id="busuanzi_value_page_pv"></span> 人阅读</span></div></header><div class="article-entry" itemprop="articleBody"><blockquote><p>上一篇里，介绍了Axon的基本概念，并且做了一个最简单的hello例子。本篇将更进一步，完成两个小目标：</p><ol><li>集成SpringBoot；</li><li>使用Standard Repository来存储Aggregate的最新状态。</li></ol></blockquote><h2 id="1-更新Maven依赖"><a href="#1-更新Maven依赖" class="headerlink" title="1. 更新Maven依赖"></a>1. 更新Maven依赖</h2><p>干几件事：</p><ul><li>集成Springboot</li><li>加入spring-boot-starter-data-jpa(Spring提供的JPA快速包，很方便)</li><li>加入my-sql-connector</li><li>加入spring-boot-starter-web包，提供web接口调用，测试用</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-提供application-properties，配置好数据库信息"><a href="#2-提供application-properties，配置好数据库信息" class="headerlink" title="2. 提供application.properties，配置好数据库信息"></a>2. 提供application.properties，配置好数据库信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Datasource configuration</span><br><span class="line">spring.datasource.url=jdbc:mysql:<span class="comment">//xxx.xxx.xxx.xxx:3306/cqrs</span></span><br><span class="line">spring.datasource.driverClassName=com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.username=&lt;username&gt;</span><br><span class="line">spring.datasource.password=&lt;password&gt;</span><br><span class="line">spring.datasource.validation-query=SELECT <span class="number">1</span>;</span><br><span class="line">spring.datasource.initial-size=<span class="number">2</span></span><br><span class="line">spring.datasource.sql-script-encoding=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line">spring.jpa.database=mysql</span><br><span class="line">spring.jpa.show-sql=<span class="keyword">true</span></span><br><span class="line">spring.jpa.hibernate.ddl-auto=create-drop</span><br></pre></td></tr></table></figure><h2 id="3-使用Spring进行配置"><a href="#3-使用Spring进行配置" class="headerlink" title="3. 使用Spring进行配置"></a>3. 使用Spring进行配置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAxon</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = getLogger(JpaConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PlatformTransactionManager transactionManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventStorageEngine <span class="title">eventStorageEngine</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InMemoryEventStorageEngine();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionManager <span class="title">axonTransactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringTransactionManager(transactionManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventBus <span class="title">eventBus</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleEventBus();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommandBus <span class="title">commandBus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SimpleCommandBus commandBus = <span class="keyword">new</span> SimpleCommandBus(axonTransactionManager(), NoOpMessageMonitor.INSTANCE);</span><br><span class="line">        <span class="comment">//commandBus.registerHandlerInterceptor(transactionManagingInterceptor());</span></span><br><span class="line">        <span class="keyword">return</span> commandBus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionManagingInterceptor <span class="title">transactionManagingInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransactionManagingInterceptor(<span class="keyword">new</span> SpringTransactionManager(transactionManager));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">  	<span class="function"><span class="keyword">public</span> EntityManagerProvider <span class="title">entityManagerProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  		<span class="keyword">return</span> <span class="keyword">new</span> ContainerManagedEntityManagerProvider();</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line">	  <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Repository&lt;BankAccount&gt; <span class="title">accountRepository</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GenericJpaRepository&lt;BankAccount&gt;(entityManagerProvider(),BankAccount.class, eventBus());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@EnableAxon</code>会启用<code>SpringAxonAutoConfigurer</code>，后者会自动把上线文里的关键配置模块注入到Axon的config中。但这个注解未来会被替代，所以推荐使用方式为引入axon-spring-boot-autoconfigure包。下一篇文章就会介绍如何使用autoconfigure进行配置。<br>在本例中，我们把Event保存在内存中，所以指定EventStoreEngine为<code>InMemoryEventStorageEngine</code>。<br>前一篇说过，Axon会给每一个Aggregate创建一个AggregateRepositoryBean，来指定每一个Aggregate的实际Repository。这里我们直接声明BankAccount对应的Repository为一个<code>GenericJpaRepository</code>,来直接保存Aggregate的状态。<code>GenericJpaRepository</code>要求提供一个<code>EntityManagerProvider</code>，该Provider会提供具体的<code>EntityManager</code>来管理持久化。<br>值得注意的是，CommandBus在初始化时，需要提供一个TransactionManager，如果直接调用SimpleCommandBus的无参构造器，默认是<code>NoTransactionManager.INSTANCE</code>。本例测试时把几个command放在一个线程里串行执行，如果不提供TransactionManager，那么最终withdraw会失败。<br>提供TransactionManager的方式有两种：</p><ul><li>如上例中直接构造器中指定；</li><li>注册一个TransactionManagingInterceptor；</li></ul><h2 id="4-把Aggregate加上JPA的标准Entity注解"><a href="#4-把Aggregate加上JPA的标准Entity注解" class="headerlink" title="4. 把Aggregate加上JPA的标准Entity注解"></a>4. 把Aggregate加上JPA的标准Entity注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aggregate</span>(repository = <span class="string">"accountRepository"</span>)</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BankAccount</span> </span>&#123;</span><br><span class="line">  <span class="meta">@AggregateIdentifier</span></span><br><span class="line">  <span class="keyword">private</span> AccountId accountId;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getAccountId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> accountId.toString();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getAccountName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> accountName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> balance;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>repository = “accountRepository”指定了该Aggregate对应的Repository的Bean名字，即在JpaConfig中定义的那一个。<br>JPA要求Entity必须有一个ID，<code>GenericJpaRepository</code>默认使用String作为EntityId的类型，而这里并没有直接用String，将会在存储时报<br>java.lang.IllegalArgumentException: Provided id of the wrong type for class com.edi.learn.axon.aggregates.BankAccount. Expected: class com.edi.learn.axon.domain.AccountId, got class java.lang.String<br>解决方法是把@Id，@Column加在getter方法上。</p><h2 id="5-配置controller接受请求并发送command"><a href="#5-配置controller接受请求并发送command" class="headerlink" title="5. 配置controller接受请求并发送command"></a>5. 配置controller接受请求并发送command</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/bank"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BankAccountController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = getLogger(BankAccountController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommandGateway commandGateway;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HttpServletResponse response;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LOGGER.info(<span class="string">"start"</span>);</span><br><span class="line">        AccountId id = <span class="keyword">new</span> AccountId();</span><br><span class="line">        LOGGER.debug(<span class="string">"Account id: &#123;&#125;"</span>, id.toString());</span><br><span class="line">        commandGateway.send(<span class="keyword">new</span> CreateAccountCommand(id, <span class="string">"MyAccount"</span>,<span class="number">1000</span>));</span><br><span class="line">        commandGateway.send(<span class="keyword">new</span> WithdrawMoneyCommand(id, <span class="number">500</span>));</span><br><span class="line">        commandGateway.send(<span class="keyword">new</span> WithdrawMoneyCommand(id, <span class="number">300</span>));</span><br><span class="line">        commandGateway.send(<span class="keyword">new</span> CreateAccountCommand(id, <span class="string">"MyAccount"</span>, <span class="number">1000</span>));</span><br><span class="line">        commandGateway.send(<span class="keyword">new</span> WithdrawMoneyCommand(id, <span class="number">500</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我这里是为了偷懒，直接一个post请求就可以执行一堆操作。有心者可以改下，接受参数，根据参数发送command。</p><h2 id="6-启动类"><a href="#6-启动类" class="headerlink" title="6. 启动类"></a>6. 启动类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;<span class="string">"com.edi.learn"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>唯一需要注意的是，如果Application类不在JpaConfig包路径的前面，JpaConfig讲不会被Spring扫描注册到上下文中，需要指定包路径。</p><p>启动后，在<a href="http://localhost:8080/bank" target="_blank" rel="noopener">http://localhost:8080/bank</a> 发送一个POST请求，就可以看到log<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">17:53:47.099 [http-nio-8080-exec-1] INFO  c.e.l.a.c.aggregates.BankAccount - Account 2fabef76-80bc-4dfc-8f21-4b68c5969fa5 is created with balance 1000</span><br><span class="line">17:53:47.229 [http-nio-8080-exec-1] INFO  c.e.l.a.c.aggregates.BankAccount - Withdraw 500 from account 2fabef76-80bc-4dfc-8f21-4b68c5969fa5, balance result: 500</span><br><span class="line">17:53:47.241 [http-nio-8080-exec-1] INFO  c.e.l.a.c.aggregates.BankAccount - Withdraw 300 from account 2fabef76-80bc-4dfc-8f21-4b68c5969fa5, balance result: 200</span><br><span class="line">17:53:47.246 [http-nio-8080-exec-1] INFO  c.e.l.a.c.aggregates.BankAccount - Account 2fabef76-80bc-4dfc-8f21-4b68c5969fa5 is created with balance 1000</span><br><span class="line">17:53:47.253 [http-nio-8080-exec-1] WARN  o.a.c.gateway.DefaultCommandGateway - Command &apos;com.edi.learn.axon.command.commands.CreateAccountCommand&apos; resulted in javax.persistence.EntityExistsException(A different object with the same identifier value was already associated with the session : [com.edi.learn.axon.command.aggregates.BankAccount#2fabef76-80bc-4dfc-8f21-4b68c5969fa5])</span><br><span class="line">17:53:47.268 [http-nio-8080-exec-1] ERROR c.e.l.a.c.aggregates.BankAccount - Cannot withdraw more money than the balance!</span><br></pre></td></tr></table></figure><p></p><p>可以看到故意发送的第二个<code>CreateAccountCommand</code>时，由于id相同，提示创建失败。<br>进一步取钱时，因余额不足报错 。</p><p>本文源码：<a href="https://github.com/EdisonXu/sbs-axon/tree/master/lesson-2" target="_blank" rel="noopener">https://github.com/EdisonXu/sbs-axon/tree/master/lesson-2</a></p><div class="article-copyright"><i class="fa fa-lightbulb-o"></i> 本文由 <a href="http://edisonxu.org/2017/03/30/axon-jpa.html">EdisonXu - 徐焱飞</a> 创作，采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 进行许可。 可自由转载、引用，但需署名作者且注明文章出处。本位链接为<a href="http://edisonxu.org/2017/03/30/axon-jpa.html" target="_blank" rel="external">http://edisonxu.org/2017/03/30/axon-jpa.html</a></div><div class="article-dashang"> <span>如果您觉得文章不错,可以请我喝一杯咖啡！</span><br><a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a><div id="dim-codes" hidden="hidden"><ul class="img_box_ul"><li><img src="/css/images/weixin.png"></li><li><img src="/css/images/zhifubao.png"></li></ul></div></div><script type="text/javascript">$("#btn_donate").click(function(){$("#dim-codes").toggle(300)})</script></div><footer class="article-footer"> <a href="http://edisonxu.org/2017/03/30/axon-jpa.html#comments" class="article-comment-link">评论</a><div class="share-container"><div class="bdsharebuttonbox"> <a href="#" class="bds_more" data-cmd="more">分享到：</a> <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a> <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a> <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a> <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a> <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a></div><script>with(window._bd_share_config={common:{bdSnsKey:{},bdText:"",bdMini:"2",bdMiniList:!1,bdPic:"",bdStyle:"0",bdSize:"16"},share:{bdSize:16}},document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)</script><style>.bdshare_popup_box{border-radius:4px;border:#e1e1e1 solid 1px}.bdshare-button-style0-16 .bds_more,.bdshare-button-style0-16 a{padding-left:20px;margin:6px 10px 6px 0}.bdshare_dialog_list a,.bdshare_popup_bottom a,.bdshare_popup_list a{font-family:'Microsoft Yahei'}.bdshare_popup_top{display:none}.bdshare_popup_bottom{height:auto;padding:5px}</style></div></footer></div><nav id="article-nav"> <a href="/2017/03/30/axon-event-sourcing.html" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">上一篇</strong><div class="article-nav-title"> CQRS和Event Sourcing系列（五）： Axon使用EventSourcing和AutoConfigure</div></a> <a href="/2017/03/30/hello-axon.html" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">下一篇</strong><div class="article-nav-title">CQRS和Event Sourcing系列（三）： Hello,Axon3</div></a></nav></article><section id="comments"><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><div id="hot-news-wrap"></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">公告</h3><div class="widget"><div class="card-front animated col s12 m12 l8 offset-l2 fadeInUp"><p class="board"> 您好，您是第<span id="busuanzi_value_site_uv"></span>位访客<br> QQ：228831793<br> 微信：fei158383<br> 邮箱：edisonxu@outlook.com<br> CQRS&ES交流群：57241527<br><br> 欢迎交流与分享经验!</p></div></div></div><div class="widget-wrap"><h3 class="widget-title">归档</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">2</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签云</h3><div class="widget tagcloud"> <a href="/tags/CQRS/" style="font-size:20px">CQRS</a> <a href="/tags/DDD/" style="font-size:20px">DDD</a> <a href="/tags/JHipster/" style="font-size:10px">JHipster</a> <a href="/tags/SpringBoot/" style="font-size:10px">SpringBoot</a> <a href="/tags/actor/" style="font-size:13.33px">actor</a> <a href="/tags/akka/" style="font-size:16.67px">akka</a> <a href="/tags/axon/" style="font-size:20px">axon</a> <a href="/tags/eventsourcing/" style="font-size:20px">eventsourcing</a> <a href="/tags/eventuate/" style="font-size:10px">eventuate</a> <a href="/tags/多线程/" style="font-size:10px">多线程</a> <a href="/tags/并发/" style="font-size:13.33px">并发</a> <a href="/tags/并行/" style="font-size:10px">并行</a> <a href="/tags/微服务/" style="font-size:10px">微服务</a> <a href="/tags/感悟/" style="font-size:10px">感悟</a> <a href="/tags/杂项/" style="font-size:10px">杂项</a></div></div><div class="widget-wrap widget-list"><h3 class="widget-title">链接</h3><div class="widget"><ul><li> <a href="http://bbs.springcloud.cn">SpringCloud中文社区</a></li><li> <a href="http://www.spring4all.com">Spring For All社区</a></li><li> <a href="http://itmuch.com">周立|Spring Cloud</a></li><li> <a href="http://blog.didispace.com">程序猿DD</a></li><li> <a href="http://www.cnblogs.com/netfocus">汤雪华的博客</a></li><li> <a href="http://edisonxu.com">EdisonXu</a></li></ul></div></div><div id="toTop" class="fa fa-angle-up"></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"> &copy; 2018 Edison Xu<br> 本站总访问量<span id="busuanzi_value_site_pv"></span>次<br> <a href="http://www.miitbeian.gov.cn/publish/query/indexFirst.action" target="_blank">沪ICP备18006173号</a></div></div></footer><script>var cloudTieConfig={url:document.location.href,sourceId:"",productKey:"5b17b705ee04468c8699e7e4e10d97d6",target:"cloud-tie-wrapper"}</script><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var yunModuleEnv=!0</script><script>var yunTieProductKey="5b17b705ee04468c8699e7e4e10d97d6",yunHotNewsWrap="hot-news-wrap";Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vZXh0ZW5kL2hvdF9uZXdzX3NjcmlwdC5odG1s",!0)</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/vendor/lightgallery/js/lightgallery.min.js"></script><script src="/vendor/lightgallery/js/lg-thumbnail.min.js"></script><script src="/vendor/lightgallery/js/lg-pager.min.js"></script><script src="/vendor/lightgallery/js/lg-autoplay.min.js"></script><script src="/vendor/lightgallery/js/lg-fullscreen.min.js"></script><script src="/vendor/lightgallery/js/lg-zoom.min.js"></script><script src="/vendor/lightgallery/js/lg-hash.min.js"></script><script src="/vendor/lightgallery/js/lg-share.min.js"></script><script src="/vendor/lightgallery/js/lg-video.min.js"></script><script src="/js/main.js"></script></div></body></html>