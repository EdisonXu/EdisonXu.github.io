<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><title>Axon入门系列(二)：Hello,Axon3 | CQRS | axon | DDD | Edison Xu&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="AxonFramework是一个轻量级的CQRS框架，支持EventSourcing，本系列将开始通过例子，StepByStep学习AxonFramework。  简介AxonFramework是一个基于事件驱动的轻量级CQRS框架，既支持直接持久化Aggreaget状态，也支持采用EventSourcing，使用AxonFramework的应用架构如下"><meta name="keywords" content="CQRS,axon,DDD"><meta property="og:type" content="article"><meta property="og:title" content="Axon入门系列(二)：Hello,Axon3"><meta property="og:url" content="http://edisonxu.com/2017/03/30/hello-axon.html"><meta property="og:site_name" content="Edison Xu&#39;s Blog"><meta property="og:description" content="AxonFramework是一个轻量级的CQRS框架，支持EventSourcing，本系列将开始通过例子，StepByStep学习AxonFramework。  简介AxonFramework是一个基于事件驱动的轻量级CQRS框架，既支持直接持久化Aggreaget状态，也支持采用EventSourcing，使用AxonFramework的应用架构如下"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="http://edisonxu.com/images/2017/03/detailed-architecture-overview.png"><meta property="og:image" content="http://edisonxu.com/images/2017/03/distributed-command-bus.png"><meta property="og:updated_time" content="2018-10-30T01:56:14.201Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Axon入门系列(二)：Hello,Axon3"><meta name="twitter:description" content="AxonFramework是一个轻量级的CQRS框架，支持EventSourcing，本系列将开始通过例子，StepByStep学习AxonFramework。  简介AxonFramework是一个基于事件驱动的轻量级CQRS框架，既支持直接持久化Aggreaget状态，也支持采用EventSourcing，使用AxonFramework的应用架构如下"><meta name="twitter:image" content="http://edisonxu.com/images/2017/03/detailed-architecture-overview.png"><link rel="alternate" href="/atom.xml" title="Edison Xu&#39;s Blog" type="application/atom+xml"><link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/vendor/open-sans/styles.css"><link rel="stylesheet" href="/vendor/source-code-pro/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/vendor/jquery/2.1.3/jquery.min.js"></script><link rel="stylesheet" href="/vendor/lightgallery/css/lightgallery.min.css"></head><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><i class="logo"></i> <span class="site-title">Edison Xu&#39;s Blog</span></a><nav id="main-nav"> <a class="main-nav-link" href="/.">主页</a> <a class="main-nav-link" href="/archives">目录</a> <a class="main-nav-link" href="http://blog.csdn.net/xeseo">旧站</a> <a class="main-nav-link" href="/about">关于我</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"> <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/e8022ebe2f6f01924ccded8d4db8b9fa"><i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form class="search-form"> <input type="text" class="ins-search-input search-form-input" placeholder="搜索"> <button type="submit" class="search-form-submit"></button></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"> <input type="text" class="ins-search-input" placeholder="想要查找什么..."><span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script></div></div></div><div id="main-nav-mobile" class="header-sub header-inner"><table class="menu outer"><tr><td><a class="main-nav-link" href="/.">主页</a></td><td><a class="main-nav-link" href="/archives">目录</a></td><td><a class="main-nav-link" href="http://blog.csdn.net/xeseo">旧站</a></td><td><a class="main-nav-link" href="/about">关于我</a></td><td><div class="search-form"> <input type="text" class="ins-search-input search-form-input" placeholder="搜索"></div></td></tr></table></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"> <img id="avatar" src="https://www.gravatar.com/avatar/e8022ebe2f6f01924ccded8d4db8b9fa?s=128"><h2 id="name">Edison Xu</h2><h3 id="title">懂得前端和移动，设计过架构，做过管理，也搞过自动化和运维，明白各种测试，知晓处理大数据。保持危机感和谦逊，方能更进一步</h3><span id="location"><i class="fa fa-map-marker"></i> 中国 - 上海</span> <a id="follow" target="_blank" href="http://edisonxu.com/about">关注我</a></div><div class="article-info profile-block"><div class="article-info-block"> 16 <span>文章</span></div><div class="article-info-block"> 16 <span>标签</span></div></div><div class="profile-block social-links"><table><tr><td><a href="https://github.com/EdisonXu" target="_blank" title="github" class="tooltip"><i class="fa fa-github"></i></a></td><td><a href="mailto:edisonxu@outlook.com" target="_blank" title="envelope" class="tooltip"><i class="fa fa-envelope"></i></a></td><td><a href="/css/images/myweixin.jpg" target="_blank" title="weixin" class="tooltip"><i class="fa fa-weixin"></i></a></td><td><a href="/atom.xml" target="_blank" title="rss" class="tooltip"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-hello-axon" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name"> Axon入门系列(二)：Hello,Axon3</h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2017/03/30/hello-axon.html"><time datetime="2017-03-30T06:47:46.000Z" itemprop="datePublished">2017-03-30</time></a></div><i class="fa fa-tag"></i> <a class="tag-link" href="/tags/CQRS/">CQRS</a>, <a class="tag-link" href="/tags/DDD/">DDD</a>, <a class="tag-link" href="/tags/axon/">axon</a><span id="busuanzi_container_site_pv" style="display:none;float:right"><i class="fa fa-eye" aria-hidden="true" style="margin-right:5px"></i><span id="busuanzi_value_page_pv"></span> 人阅读</span></div></header><div class="article-entry" itemprop="articleBody"><blockquote><p>AxonFramework是一个轻量级的CQRS框架，支持EventSourcing，本系列将开始通过例子，StepByStep学习AxonFramework。</p></blockquote><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><a href="www.axonframework.org">AxonFramework</a>是一个基于事件驱动的轻量级CQRS框架，既支持直接持久化Aggreaget状态，也支持采用EventSourcing，使用AxonFramework的应用架构如下<br><img src="/images/2017/03/detailed-architecture-overview.png" alt=""></p><p>引入Axon非常简单，加入Maven依赖即可<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.axonframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>axon-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;axon.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>AxonFramework的源码地址：<a href="https://github.com/AxonFramework/AxonFramework" target="_blank" rel="noopener">https://github.com/AxonFramework/AxonFramework</a><br>包含了如下组件；</p><ul><li><code>core</code> axon的核心代码</li><li><code>amqp</code> 使用AMQP协议的MQ，如rabbit等，实现Event跨JVM的分发</li><li><code>distributed-commandbus-jgroups</code> 使用Jgroup实现跨JVM的Command分发</li><li><code>distributed-commandbus-springcloud</code> 与SpringCloud集成，使用DiscoveryClient和RESTemplate实现跨JVM的Command分发</li><li><code>metrics</code> 提供监控相关信息</li><li><code>mongo</code> 实现axon与mongoDB的集成</li><li><code>spring-boot-autoconfigure</code> 实现spring的autoconfigure支持，只需要提供相关Property就可以自动配置Axon</li><li><code>spring-boot-starter-jgroups</code> 用distributed-commandbus-jgroups加上spring autoconfigure，提供jgroup“一键”集成</li><li><code>spring-boot-starter</code> 与springboot集成</li><li><code>spring</code> 提供各种annotation，与spring集成</li></ul><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>废话不多说，我们来用一个简单的例子来说明AxonFramework最基本的使用方法：<br>“开一个银行账户，取钱”</p><h2 id="Aggregate"><a href="#Aggregate" class="headerlink" title="Aggregate"></a>Aggregate</h2><p>显然，在这个例子中，我们要实现一个Aggregate是银行账户，定义如下<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BankAccount</span> </span>&#123;</span><br><span class="line">    <span class="meta">@AggregateIdentifier</span></span><br><span class="line">    <span class="keyword">private</span> AccountId accountId;</span><br><span class="line">    <span class="keyword">private</span> String accountName;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal balance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>Axon中定义一个class是Aggregate有两种方法：</p><ol><li>在配置中直接指定，如调用.configureAggregate(BankAccount.class)；</li><li>与Spring集成时，可以通过加上@Aggregate的注解标明；<br>结合前文DDD概念中关于Aggregate的介绍，每个Aggregate都有自己独立的全局唯一的标识符，<code>@AggregateIdentifier</code>即是这个唯一标识的标志，例子中就是银行的AccountId。一个AggregateIdentifier必须：</li></ol><ul><li>实现<code>equal</code>和<code>hashCode</code>方法，因为它会被拿来与其他标识对比</li><li>实现<code>toString</code>方法，其结果也应该是全局唯一的</li><li>实现<code>Serializable</code>接口以表明可序列化</li></ul><p>这里用Axon提供的generateIdentifier方法来创建唯一标识：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7119961474083133148L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String identifier;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> hashCode;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccountId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.identifier = IdentifierFactory.getInstance().generateIdentifier();</span><br><span class="line">        <span class="keyword">this</span>.hashCode = identifier.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccountId</span><span class="params">(String identifier)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(identifier, ()-&gt;<span class="string">"Identifier may not be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.identifier = identifier;</span><br><span class="line">        <span class="keyword">this</span>.hashCode = identifier.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        AccountId accountId = (AccountId) o;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> identifier.equals(accountId.identifier);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> identifier;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="Command"><a href="#Command" class="headerlink" title="Command"></a>Command</h2><p>在CQRS模式下，所有的“写”操作，都是发送Command来操作。Axon中Command可以是任意的POJO类，由于axon是基于事件驱动的架构，Command类处理时会被axon封装成一个<code>CommandMessage</code>。<br>本例只需要实现两个Command:<br><code>CreateAccountCommand</code><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateAccountCommand</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AccountId accountId;</span><br><span class="line">    <span class="keyword">private</span> String accountName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> amount;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreateAccountCommand</span><span class="params">(AccountId accountId, String accountName, <span class="keyword">long</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accountId = accountId;</span><br><span class="line">        <span class="keyword">this</span>.accountName = accountName;</span><br><span class="line">        <span class="keyword">this</span>.amount = amount;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//getter &amp; setter</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>WithdrawMoneyCommand</code><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WithdrawMoneyCommand</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TargetAggregateIdentifier</span></span><br><span class="line">    <span class="keyword">private</span> AccountId accountId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> amount;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WithdrawMoneyCommand</span><span class="params">(AccountId accountId, <span class="keyword">long</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accountId = accountId;</span><br><span class="line">        <span class="keyword">this</span>.amount = amount;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//getter &amp; setter</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>篇幅问题，我这里省略了getter/setter方法，但是，<strong>如果使用Jackson做序列化器，必须实现空参构造器和提供所有field的getter方法！</strong></p><h2 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h2><p>Event是系统中发生任何改变时产生的事件类，典型的event就是对Aggregate状态的修改。与Command一样，Event可以是任何POJO，axon也会把Event自动封装成<code>EventMessage</code>，其中如果是Aggregate发送出来的Event，会被封装成<code>DomainEventMessage</code>。通常来说，Event最好是可序列化的。那么对应到本例，显然有两个Event：<br><code>AccountCreatedEvent</code><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountCreatedEvent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AccountId accountId;</span><br><span class="line">    <span class="keyword">private</span> String accountName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> amount;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccountCreatedEvent</span><span class="params">(AccountId accountId, String accountName, <span class="keyword">long</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accountId = accountId;</span><br><span class="line">        <span class="keyword">this</span>.accountName = accountName;</span><br><span class="line">        <span class="keyword">this</span>.amount = amount;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//getter &amp; setter</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>MoneyWithdrawnEvent</code><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MoneyWithdrawnEvent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AccountId accountId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> amount;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MoneyWithdrawnEvent</span><span class="params">(AccountId accountId, <span class="keyword">long</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accountId = accountId;</span><br><span class="line">        <span class="keyword">this</span>.amount = amount;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//getter &amp; setter</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>一样，省略了gettter/setter，注意序列化器对构造器和getter的要求。</p><h2 id="CommandHandler"><a href="#CommandHandler" class="headerlink" title="CommandHandler"></a>CommandHandler</h2><p>axon使用@CommandHandler注解来标明用来处理Command的方法，配置时会把这些CommandHandler统一加载管理，与其对应的Command形成KV键值对。在Aggregate实现BankAccount里面加入CommandHandler如下：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CommandHandler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BankAccount</span><span class="params">(CreateAccountCommand command)</span></span>&#123;</span><br><span class="line">   apply(<span class="keyword">new</span> AccountCreatedEvent(command.getAccountId(), command.getAccountName(), command.getAmount()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CommandHandler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(WithdrawMoneyCommand command)</span></span>&#123;</span><br><span class="line">   apply(<span class="keyword">new</span> MoneyWithdrawnEvent(command.getAccountId(), command.getAmount()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这里不做其他事，只简单的产生Event并使用提供的静态方法<code>apply</code>把Event发送出去。<br>值得一提的是，这里用一个构造器来接受<code>CreateAccountCommand</code>，至于有什么特殊，这里卖个关子，文章最后见分晓。</p><h2 id="EventHandler"><a href="#EventHandler" class="headerlink" title="EventHandler"></a>EventHandler</h2><p>专门用来处理Event的方法，用@EventHandler标明或使用<code>EventHandlingConfiguration</code>去注册。在BankAccount内加入：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EventHandler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">(AccountCreatedEvent event)</span></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.accountId = event.getAccountId();</span><br><span class="line">    <span class="keyword">this</span>.accountName = event.getAccountName();</span><br><span class="line">    <span class="keyword">this</span>.balance = <span class="keyword">new</span> BigDecimal(event.getAmount());</span><br><span class="line">    LOGGER.info(<span class="string">"Account &#123;&#125; is created with balance &#123;&#125;"</span>, accountId, <span class="keyword">this</span>.balance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EventHandler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">(MoneyWithdrawnEvent event)</span></span>&#123;</span><br><span class="line">    BigDecimal result = <span class="keyword">this</span>.balance.subtract(<span class="keyword">new</span> BigDecimal(event.getAmount()));</span><br><span class="line">    <span class="keyword">if</span>(result.compareTo(BigDecimal.ZERO)&lt;<span class="number">0</span>)</span><br><span class="line">        LOGGER.error(<span class="string">"Cannot withdraw more money than the balance!"</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.balance = result;</span><br><span class="line">        LOGGER.info(<span class="string">"Withdraw &#123;&#125; from account &#123;&#125;, balance result: &#123;&#125;"</span>, event.getAmount(), accountId, balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>现在基本内容都有了，只差最后一步，对axon进行配置。Axon启动最少要指定如下几个模块：</p><h3 id="CommandBus"><a href="#CommandBus" class="headerlink" title="CommandBus"></a><code>CommandBus</code></h3><p> <code>CommandBus</code>是用来分发Command到对应<code>CommandHandler</code>的机制。每一个Command只会发送到一个<code>CommandHandler</code>去，当有多个<code>CommandHandler</code>去订阅一个<code>CommandMessage</code>时，最后一个覆盖前面所有。<br> Axon内置了四种<code>CommandBus</code>：</p><ul><li><p><code>SimpleCommandBus</code><br>默认，直接在发送线程里去执行command handler，执行后保存Aggregate状态和发送事件也都在同一个线程上，适用于大多数情况。</p></li><li><p><code>AsynchrounousCommandBus</code><br>默认使用一个<code>CachedThreadPool</code>来起一个新线程去处理command。<code>CachedThreadPool</code>线程调用时，会检查是否有可用的线程，没有则创建。闲置线程60s后自动关闭。也可以通过config指定其他的线程池来采用不同的线程调度策略。</p></li><li><p><code>DisruptorCommandBus</code><br>适用于多线程场景。<code>SimpleCommandBus</code>在遇到多线程调用时，为了保证aggregate的状态，必须要加锁，这样就降低了效率。<code>DisruptorCommandBus</code>用了开源的并发处理框架<a href="http://lmax-exchange.github.io/disruptor" target="_blank" rel="noopener">Disruptor</a>，用两组线程来处理多线程场景，一组用于执行command handler去更新aggregate的状态，一组用于存储和发送所产生的event到EventStore。<br>但是<code>DisruptorCommandBus</code>有以下的限制：</p><ol><li>仅支持Event Sourced Aggregates</li><li>一个Command只能改变一个Aggregate的状态。<ol><li>当使用Cache的时候，一个identifier只能对应一个aggregate，即不允许两个不同类型的aggregate拥有同一个identifier</li><li>所处理的Command不能导致UnitOfWork的rollback，因为DisruptorCommandBus无法保证rollback时按照dispatch的顺序来处理。</li><li>用于更新Aggregate的command只能按照dispatch的顺序执行，无法指定顺序。<br>DisruptorCommandBus可以使用DisruptorConfiguration来配置，它提供了一些进一步优化的参数。</li></ol></li></ol></li><li><p><code>DistributedCommandBus</code><br>不像其他CommandBus，DistributedCommandBus并不调用任何command handler，它只是在不同JVM的commandbus之间建立一个“桥梁”。每个JVM上的DistributedCommandBus被称为“Segment”。<br><img src="/images/2017/03/distributed-command-bus.png" alt=""><br>DistributedCommandBus需要指定路由规则和具体的connector，这两个东东具体实现由<code>distributed-commandbus-xxx</code>模块提供。</p></li></ul><h3 id="EventBus"><a href="#EventBus" class="headerlink" title="EventBus"></a><code>EventBus</code></h3><p> <code>EventBus</code>用于把event发送到subscribe它的各个handler去。Axon提供了两种EventBus的实现，都支持订阅和跟踪：</p><ul><li><code>SimpleEventBus</code> 默认的EventBus，不持久化event，一旦发送到消费者去，就会销毁。</li><li><code>EmbeddedEventStore</code> 可以持久化event，以便以后replay。</li></ul><h3 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a><code>Repository</code></h3><p> 即<code>Aggregate</code>的持久化方式。Axon内置了两种</p><ul><li><code>Standard Repositories</code> 代表是<code>GenericJpaRepository</code>，直接把Aggregate的最新状态存到db去。</li><li><code>Event Sourcing Repositories</code> 并不直接保存Aggregate的最新状态，而是保存对Aggregate造成影响的所有Event，通过Event回溯来恢复Aggregate状态</li></ul><h3 id="EventStorageEngine"><a href="#EventStorageEngine" class="headerlink" title="EventStorageEngine"></a><code>EventStorageEngine</code></h3><p> 提供event在底层storage读写的机制，内置了若干种：</p><ul><li><code>InMemoryEventStorageEngine</code> 存储到内存中</li><li><code>JpaEventStorageEngine</code> 使用JPA进行存储</li><li><code>JdbcEventStorageEngine</code> 使用jdbc</li><li><code>MongoEventStorageEngine</code> 使用Mongodb存储event</li></ul><h3 id="Serializer"><a href="#Serializer" class="headerlink" title="Serializer"></a><code>Serializer</code></h3><p> 由于是事件驱动框架，序列化器必不可少。Axon内置了三种：XStreamSerializer, JavaSerializer, JacksonSerializer，默认是XStreamSerializer，使用<a href="http://xstream.codehaus.org" target="_blank" rel="noopener">XStream</a>来做序列化，理论上比Java自带的序列化器要快。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = getLogger(Application.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        Configuration config = DefaultConfigurer.defaultConfiguration()</span><br><span class="line">                .configureAggregate(BankAccount.class)</span><br><span class="line">                .configureEmbeddedEventStore(c -&gt; <span class="keyword">new</span> InMemoryEventStorageEngine())</span><br><span class="line">                .buildConfiguration();</span><br><span class="line">        config.start();</span><br><span class="line">        AccountId id = <span class="keyword">new</span> AccountId();</span><br><span class="line">        config.commandGateway().send(<span class="keyword">new</span> CreateAccountCommand(id, <span class="string">"MyAccount"</span>,<span class="number">1000</span>));</span><br><span class="line">        config.commandGateway().send(<span class="keyword">new</span> WithdrawMoneyCommand(id, <span class="number">500</span>));</span><br><span class="line">        config.commandGateway().send(<span class="keyword">new</span> WithdrawMoneyCommand(id, <span class="number">500</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Axon提供了DefaultConfigurer来帮助我们做一些基本配置，所以我们只需要简单的做Aggregate的注册和指定一个EventStorageEngine。<br>这里因为是测试，用了<code>InMemoryEventStorageEngine</code>。<br><code>CommandGateway</code>是对<code>CommandBus</code>的一个封装，更加方便的来发送Command。</p><hr><p>本文完整代码<br><a href="https://github.com/EdisonXu/sbs-axon/tree/master/lesson-1" target="_blank" rel="noopener">https://github.com/EdisonXu/sbs-axon/tree/master/lesson-1</a></p><p>前面说用一个构造器来接受<code>CreateAccountCommand</code>，有什么特殊地方。这里涉及到一个问题，就是Aggregate在Repository的创建。<br>Axon中，打开@Aggregate注解的定义会发现里面其实定义了一个repository。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Selects the name of the AggregateRepository bean. If left empty a new repository is created. In that case the</span></span><br><span class="line"><span class="comment"> * name of the repository will be based on the simple name of the aggregate's class.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">String <span class="title">repository</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br></pre></td></tr></table></figure><p></p><p>Axon其实会为每一个Aggregate对应一个AggregateRepository，如果不额外指定，会使用给定的StorageEngine对应的Repository。<br>通常情况下，如果要在Repository里面保存Aggregate，需要执行repository.newInstance(()-&gt;new BankAccount())，但如果直接提供了构造器接受command，那么axon在执行这个command，如<code>CreateAccountCommand</code>时，会自动帮你做一个newInstance的操作。<br>另外，有人会说，为什么要把CommandHandler、EventHandler放到Aggregate内部，能不能放到外面单独用一个类。答案是当然可以。<br>Axon会自动扫描带有@CommandHandler,@EventHandler的方法，加载到KV值中。<br>并没有明确规定说这些方法一定得放在Aggregate内部或外部，不过一般应该把仅涉及当前Aggregate状态变化的，放到Aggregate内部处理，如果牵扯到其他复杂逻辑，如查询其他Aggregate做判断等，则最好是另起一个handler类。</p><div class="article-copyright"><i class="fa fa-lightbulb-o"></i> 本文由 <a href="http://edisonxu.com/2017/03/30/hello-axon.html">EdisonXu - 徐焱飞</a> 创作，采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 进行许可。 可自由转载、引用，但需署名作者且注明文章出处。本位链接为<a href="http://edisonxu.com/2017/03/30/hello-axon.html" target="_blank" rel="external">http://edisonxu.com/2017/03/30/hello-axon.html</a></div><div class="article-dashang"> <span>如果您觉得文章不错,可以请我喝一杯咖啡！</span><br><a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a><div id="dim-codes" hidden="hidden"><ul class="img_box_ul"><li><img src="/css/images/weixin.png"></li><li><img src="/css/images/zhifubao.png"></li></ul></div></div><script type="text/javascript">$("#btn_donate").click(function(){$("#dim-codes").toggle(300)})</script></div><footer class="article-footer"><div class="share-container"><div class="bdsharebuttonbox"> <a href="#" class="bds_more" data-cmd="more">分享到：</a> <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a> <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a> <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a> <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a> <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a></div><script>with(window._bd_share_config={common:{bdSnsKey:{},bdText:"",bdMini:"2",bdMiniList:!1,bdPic:"",bdStyle:"0",bdSize:"16"},share:{bdSize:16}},document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)</script><style>.bdshare_popup_box{border-radius:4px;border:#e1e1e1 solid 1px}.bdshare-button-style0-16 .bds_more,.bdshare-button-style0-16 a{padding-left:20px;margin:6px 10px 6px 0}.bdshare_dialog_list a,.bdshare_popup_bottom a,.bdshare_popup_list a{font-family:'Microsoft Yahei'}.bdshare_popup_top{display:none}.bdshare_popup_bottom{height:auto;padding:5px}</style></div></footer></div><nav id="article-nav"> <a href="/2017/03/30/axon-jpa.html" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">上一篇</strong><div class="article-nav-title"> Axon入门系列(三)：Axon使用Jpa存储Aggregate状态</div></a> <a href="/2017/03/23/hello-cqrs.html" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">下一篇</strong><div class="article-nav-title">Axon入门系列(一)：CQRS基本概念</div></a></nav></article><section id="comments"><div id="gitalk-container"></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">公告</h3><div class="widget"><div class="card-front animated col s12 m12 l8 offset-l2 fadeInUp"><p class="board"> 您好，您是第<span id="busuanzi_value_site_uv"></span>位访客<br> QQ：228831793<br> 微信：fei158383<br> 邮箱：edisonxu@outlook.com<br> CQRS&ES交流群：57241527<br><br> 欢迎交流与分享经验!</p></div></div></div><div class="widget-wrap"><h3 class="widget-title">归档</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">2</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签云</h3><div class="widget tagcloud"> <a href="/tags/CQRS/" style="font-size:20px">CQRS</a> <a href="/tags/DDD/" style="font-size:20px">DDD</a> <a href="/tags/JHipster/" style="font-size:10px">JHipster</a> <a href="/tags/SpringBoot/" style="font-size:10px">SpringBoot</a> <a href="/tags/actor/" style="font-size:12.5px">actor</a> <a href="/tags/akka/" style="font-size:15px">akka</a> <a href="/tags/axon/" style="font-size:20px">axon</a> <a href="/tags/event-sourcing/" style="font-size:10px">event sourcing</a> <a href="/tags/eventsourcing/" style="font-size:17.5px">eventsourcing</a> <a href="/tags/eventuate/" style="font-size:10px">eventuate</a> <a href="/tags/多线程/" style="font-size:10px">多线程</a> <a href="/tags/并发/" style="font-size:12.5px">并发</a> <a href="/tags/并行/" style="font-size:10px">并行</a> <a href="/tags/微服务/" style="font-size:10px">微服务</a> <a href="/tags/感悟/" style="font-size:10px">感悟</a> <a href="/tags/杂项/" style="font-size:10px">杂项</a></div></div><div class="widget-wrap widget-list"><h3 class="widget-title">链接</h3><div class="widget"><ul><li> <a href="http://bbs.springcloud.cn">SpringCloud中文社区</a></li><li> <a href="http://www.spring4all.com">Spring For All社区</a></li><li> <a href="http://itmuch.com">周立|Spring Cloud</a></li><li> <a href="http://blog.didispace.com">程序猿DD</a></li><li> <a href="http://www.cnblogs.com/netfocus">汤雪华的博客</a></li><li> <a href="http://edisonxu.com">EdisonXu</a></li></ul></div></div><div id="toTop" class="fa fa-angle-up"></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"> &copy; 2018 Edison Xu<br> 本站总访问量<span id="busuanzi_value_site_pv"></span>次<br> <a href="http://www.miitbeian.gov.cn/publish/query/indexFirst.action" target="_blank">沪ICP备18006173号</a></div></div></footer><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var gitalk=new Gitalk({clientID:"268be44c555ad2a36b32",clientSecret:"9cf79c6df51e0753755f03afea7be813f3371d91",repo:"EdisonXu.github.io",owner:"EdisonXu",admin:["EdisonXu"],id:md5(window.location.pathname),distractionFreeMode:!1});gitalk.render("gitalk-container")</script> %><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/vendor/lightgallery/js/lightgallery.min.js"></script><script src="/vendor/lightgallery/js/lg-thumbnail.min.js"></script><script src="/vendor/lightgallery/js/lg-pager.min.js"></script><script src="/vendor/lightgallery/js/lg-autoplay.min.js"></script><script src="/vendor/lightgallery/js/lg-fullscreen.min.js"></script><script src="/vendor/lightgallery/js/lg-zoom.min.js"></script><script src="/vendor/lightgallery/js/lg-hash.min.js"></script><script src="/vendor/lightgallery/js/lg-share.min.js"></script><script src="/vendor/lightgallery/js/lg-video.min.js"></script><script src="/js/main.js"></script></div></body></html>