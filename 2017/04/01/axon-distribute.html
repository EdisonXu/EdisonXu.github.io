<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><title>CQRS和Event Sourcing系列（八）：DistributeCommand和DistributeEvent | Edison Xu&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="上一篇我们才算真正实现了一个基于Axon3的例子，本篇我们来尝试实现在分布式环境下利用Axon3做CQRS，即把CommandSide和QuerySide变成两个独立应用，分别可以启多份实例。  首先，我们回顾一下CQRS&amp;amp;EventSourcing模式下，整个架构的关键点，或者说最大的特点：  CommandSide和QuerySide的持久层分离； 保存对Aggregate状态造成变"><meta name="keywords" content="eventsourcing,CQRS,axon,DDD"><meta property="og:type" content="article"><meta property="og:title" content="CQRS和Event Sourcing系列（八）：DistributeCommand和DistributeEvent"><meta property="og:url" content="http://edisonxu.org/2017/04/01/axon-distribute.html"><meta property="og:site_name" content="Edison Xu&#39;s Blog"><meta property="og:description" content="上一篇我们才算真正实现了一个基于Axon3的例子，本篇我们来尝试实现在分布式环境下利用Axon3做CQRS，即把CommandSide和QuerySide变成两个独立应用，分别可以启多份实例。  首先，我们回顾一下CQRS&amp;amp;EventSourcing模式下，整个架构的关键点，或者说最大的特点：  CommandSide和QuerySide的持久层分离； 保存对Aggregate状态造成变"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="http://edisonxu.org/images/2017/03/distributed-command-bus.png"><meta property="og:image" content="http://edisonxu.org/images/2017/04/producer_consumer.png"><meta property="og:image" content="http://edisonxu.org/images/2017/04/direct_exchange.png"><meta property="og:image" content="http://edisonxu.org/images/2017/04/fanout_exchange.png"><meta property="og:image" content="http://edisonxu.org/images/2017/04/topic_exchange.png"><meta property="og:updated_time" content="2018-02-23T02:19:15.402Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="CQRS和Event Sourcing系列（八）：DistributeCommand和DistributeEvent"><meta name="twitter:description" content="上一篇我们才算真正实现了一个基于Axon3的例子，本篇我们来尝试实现在分布式环境下利用Axon3做CQRS，即把CommandSide和QuerySide变成两个独立应用，分别可以启多份实例。  首先，我们回顾一下CQRS&amp;amp;EventSourcing模式下，整个架构的关键点，或者说最大的特点：  CommandSide和QuerySide的持久层分离； 保存对Aggregate状态造成变"><meta name="twitter:image" content="http://edisonxu.org/images/2017/03/distributed-command-bus.png"><link rel="alternate" href="/atom.xml" title="Edison Xu&#39;s Blog" type="application/atom+xml"><link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/vendor/open-sans/styles.css"><link rel="stylesheet" href="/vendor/source-code-pro/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/vendor/jquery/2.1.3/jquery.min.js"></script><link rel="stylesheet" href="/vendor/lightgallery/css/lightgallery.min.css"></head><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><i class="logo"></i> <span class="site-title">Edison Xu&#39;s Blog</span></a><nav id="main-nav"> <a class="main-nav-link" href="/.">主页</a> <a class="main-nav-link" href="/archives">目录</a> <a class="main-nav-link" href="http://blog.csdn.net/xeseo">旧站</a> <a class="main-nav-link" href="/about">关于我</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"> <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/e8022ebe2f6f01924ccded8d4db8b9fa"><i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form class="search-form"> <input type="text" class="ins-search-input search-form-input" placeholder="搜索"> <button type="submit" class="search-form-submit"></button></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"> <input type="text" class="ins-search-input" placeholder="想要查找什么..."><span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script></div></div></div><div id="main-nav-mobile" class="header-sub header-inner"><table class="menu outer"><tr><td><a class="main-nav-link" href="/.">主页</a></td><td><a class="main-nav-link" href="/archives">目录</a></td><td><a class="main-nav-link" href="http://blog.csdn.net/xeseo">旧站</a></td><td><a class="main-nav-link" href="/about">关于我</a></td><td><div class="search-form"> <input type="text" class="ins-search-input search-form-input" placeholder="搜索"></div></td></tr></table></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"> <img id="avatar" src="https://www.gravatar.com/avatar/e8022ebe2f6f01924ccded8d4db8b9fa?s=128"><h2 id="name">Edison Xu</h2><h3 id="title">懂得前端和移动，设计过架构，做过管理，也搞过自动化和运维，明白各种测试，知晓处理大数据。保持危机感和谦逊，方能更进一步</h3><span id="location"><i class="fa fa-map-marker"></i> 中国 - 上海</span> <a id="follow" target="_blank" href="http://edisonxu.com/about">关注我</a></div><div class="article-info profile-block"><div class="article-info-block"> 16 <span>文章</span></div><div class="article-info-block"> 15 <span>标签</span></div></div><div class="profile-block social-links"><table><tr><td><a href="https://github.com/EdisonXu" target="_blank" title="github" class="tooltip"><i class="fa fa-github"></i></a></td><td><a href="mailto:edisonxu@outlook.com" target="_blank" title="envelope" class="tooltip"><i class="fa fa-envelope"></i></a></td><td><a href="/css/images/myweixin.jpg" target="_blank" title="weixin" class="tooltip"><i class="fa fa-weixin"></i></a></td><td><a href="/atom.xml" target="_blank" title="rss" class="tooltip"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-axon-distribute" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name"> CQRS和Event Sourcing系列（八）：DistributeCommand和DistributeEvent</h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2017/04/01/axon-distribute.html"><time datetime="2017-04-01T07:01:51.000Z" itemprop="datePublished">2017-04-01</time></a></div><i class="fa fa-tag"></i> <a class="tag-link" href="/tags/CQRS/">CQRS</a>, <a class="tag-link" href="/tags/DDD/">DDD</a>, <a class="tag-link" href="/tags/axon/">axon</a>, <a class="tag-link" href="/tags/eventsourcing/">eventsourcing</a><span id="busuanzi_container_site_pv" style="display:none;float:right"><i class="fa fa-eye" aria-hidden="true" style="margin-right:5px"></i><span id="busuanzi_value_page_pv"></span> 人阅读</span></div></header><div class="article-entry" itemprop="articleBody"><blockquote><p>上一篇我们才算真正实现了一个基于Axon3的例子，本篇我们来尝试实现在分布式环境下利用Axon3做CQRS，即把CommandSide和QuerySide变成两个独立应用，分别可以启多份实例。</p></blockquote><p>首先，我们回顾一下CQRS&amp;EventSourcing模式下，整个架构的关键点，或者说最大的特点：</p><ul><li>CommandSide和QuerySide的持久层分离；</li><li>保存对Aggregate状态造成变化的Event，而不是状态本身；</li><li>Aggregate的状态全局原子化操作；</li><li>适用于读大于写的场景；<br>我们前面的例子，是在一个应用里面实现了CQRS模式，而在分布式场景下，有如下要求：</li><li>CommandSide和QuerySide可以不在同一个节点(甚至不在同一个应用)下；</li><li>CommandSide不同的CommandHandler、EventHandler可以不在同一个节点；</li><li>不同CommandSide对同一个Aggregate的操作应具有原子性；<br>我们来一步步满足这三个要求。</li></ul><h2 id="拆分CommandSide和QuerySide"><a href="#拆分CommandSide和QuerySide" class="headerlink" title="拆分CommandSide和QuerySide"></a>拆分CommandSide和QuerySide</h2><p>这个其实比较好解决，直接把两者分别用两个SpringBoot来承载就好了，只需要引入一个MQ，传递从CommandSide到QuerySide的事件就好了。<br>Axon提供了对AMQP协议的MQ的支持，我们可以直接拿来用。当然，你也可以用Kafka等其他MQ，只是需要自己实现了。<br>具体关于Axon对AMQP的支持，在后面会详述。</p><h2 id="实现CommandHandler的分布式调用"><a href="#实现CommandHandler的分布式调用" class="headerlink" title="实现CommandHandler的分布式调用"></a>实现CommandHandler的分布式调用</h2><p>前文中提到过，Axon提供的四种CommandBus的实现中，有一个<code>DistributedCommandBus</code>，<code>DistributedCommandBus</code>不会直接调用command handler，它只是在不同JVM的commandbus之间建立一个“桥梁”。每个JVM上的<code>DistributedCommandBus</code>被称为“Segment”。<br><img src="/images/2017/03/distributed-command-bus.png" alt=""><br><code>DistributedCommandBus</code>要求提供两个参数:</p><ol><li><code>CommandRouter</code>提供路由表，指明应当把Command发到哪里。<code>CommandRouter</code>的实现必须提供Routing Strategy，以此来计算Routing Key。Axon提供了两种Routing Strategy：<ul><li>MetaDataRoutingStrategy 使用CommandMessage中的MetaData的property来找到路由key</li><li>AnnotationRoutingStrategy（默认） 使用Command中@TargetIdentifier标识的field做路由key<br><strong>所以，当使用<code>DistributeCommandBus</code>时，如果使用默认的Routing Strategy，一定要在Command中提供@TargetIdentifier</strong></li></ul></li><li><code>CommandBusConnector</code>管理链接，提供发送、订阅方法<br>Axon目前提供了两种Connector的实现：JGroupsConnector和SpringCloudConnector。本文将使用JGroup，后者将放到后一篇与SpringCloud集成一文中使用。<br>起用JGroupsConnector很简单，只需要确保如下两个依赖存在：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.axonframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>axon-spring-boot-starter-jgroups<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;axon.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.axonframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>axon-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;axon.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><p>axon-spring-boot-autoconfigure提供了自动配置，在<code>AxonAutoConfiguration</code>类中，可以发现有如下源码<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnClass</span>(name = &#123;<span class="string">"org.axonframework.jgroups.commandhandling.JGroupsConnector"</span>, <span class="string">"org.jgroups.JChannel"</span>&#125;)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(JGroupsConfiguration.JGroupsProperties.class)</span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(<span class="string">"axon.distributed.jgroups.enabled"</span>)</span><br><span class="line"><span class="meta">@AutoConfigureAfter</span>(JpaConfiguration.class)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JGroupsConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(JGroupsConfiguration.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JGroupsProperties jGroupsProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConditionalOnProperty</span>(<span class="string">"axon.distributed.jgroups.gossip.autoStart"</span>)</span><br><span class="line">    <span class="meta">@Bean</span>(destroyMethod = <span class="string">"stop"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> GossipRouter <span class="title">gossipRouter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Matcher matcher =</span><br><span class="line">                Pattern.compile(<span class="string">"([^[\\[]]*)\\[(\\d*)\\]"</span>).matcher(jGroupsProperties.getGossip().getHosts());</span><br><span class="line">        <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line"></span><br><span class="line">            GossipRouter gossipRouter = <span class="keyword">new</span> GossipRouter(matcher.group(<span class="number">1</span>), Integer.parseInt(matcher.group(<span class="number">2</span>)));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                gossipRouter.start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.warn(<span class="string">"Unable to autostart start embedded Gossip server: &#123;&#125;"</span>, e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> gossipRouter;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.error(<span class="string">"Wrong hosts pattern, cannot start embedded Gossip Router: "</span> +</span><br><span class="line">                                 jGroupsProperties.getGossip().getHosts());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DistributedCommandBus <span class="title">distributedCommandBus</span><span class="params">(CommandRouter router, CommandBusConnector connector)</span> </span>&#123;</span><br><span class="line">        DistributedCommandBus commandBus = <span class="keyword">new</span> DistributedCommandBus(router, connector);</span><br><span class="line">        commandBus.updateLoadFactor(jGroupsProperties.getLoadFactor());</span><br><span class="line">        <span class="keyword">return</span> commandBus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(&#123;CommandRouter.class, CommandBusConnector.class&#125;)</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JGroupsConnectorFactoryBean <span class="title">jgroupsConnectorFactoryBean</span><span class="params">(Serializer serializer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                   @Qualifier(<span class="string">"localSegment"</span>)</span> CommandBus</span></span><br><span class="line"><span class="function">                                                                           localSegment) </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.setProperty(<span class="string">"jgroups.tunnel.gossip_router_hosts"</span>, jGroupsProperties.getGossip().getHosts());</span><br><span class="line">        System.setProperty(<span class="string">"jgroups.bind_addr"</span>, String.valueOf(jGroupsProperties.getBindAddr()));</span><br><span class="line">        System.setProperty(<span class="string">"jgroups.bind_port"</span>, String.valueOf(jGroupsProperties.getBindPort()));</span><br><span class="line"></span><br><span class="line">        JGroupsConnectorFactoryBean jGroupsConnectorFactoryBean = <span class="keyword">new</span> JGroupsConnectorFactoryBean();</span><br><span class="line">        jGroupsConnectorFactoryBean.setClusterName(jGroupsProperties.getClusterName());</span><br><span class="line">        jGroupsConnectorFactoryBean.setLocalSegment(localSegment);</span><br><span class="line">        jGroupsConnectorFactoryBean.setSerializer(serializer);</span><br><span class="line">        jGroupsConnectorFactoryBean.setConfiguration(jGroupsProperties.getConfigurationFile());</span><br><span class="line">        <span class="keyword">return</span> jGroupsConnectorFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"axon.distributed.jgroups"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JGroupsProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Gossip gossip;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Enables JGroups configuration for this application</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> enabled = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The name of the JGroups cluster to connect to. Defaults to "Axon".</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String clusterName = <span class="string">"Axon"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The JGroups configuration file to use. Defaults to a TCP Gossip based configuration</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String configurationFile = <span class="string">"default_tcp_gossip.xml"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The address of the network interface to bind JGroups to. Defaults to a global IP address of this node.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String bindAddr = <span class="string">"GLOBAL"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Sets the initial port to bind the JGroups connection to. If this port is taken, JGroups will find the</span></span><br><span class="line"><span class="comment">         * next available port.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String bindPort = <span class="string">"7800"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Sets the loadFactor for this node to join with. The loadFactor sets the relative load this node will</span></span><br><span class="line"><span class="comment">         * receive compared to other nodes in the cluster. Defaults to 100.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> loadFactor = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Gossip <span class="title">getGossip</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> gossip;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGossip</span><span class="params">(Gossip gossip)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.gossip = gossip;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> enabled;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnabled</span><span class="params">(<span class="keyword">boolean</span> enabled)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.enabled = enabled;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getClusterName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> clusterName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClusterName</span><span class="params">(String clusterName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.clusterName = clusterName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getConfigurationFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> configurationFile;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfigurationFile</span><span class="params">(String configurationFile)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.configurationFile = configurationFile;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getBindAddr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> bindAddr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBindAddr</span><span class="params">(String bindAddr)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.bindAddr = bindAddr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getBindPort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> bindPort;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBindPort</span><span class="params">(String bindPort)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.bindPort = bindPort;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLoadFactor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> loadFactor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoadFactor</span><span class="params">(<span class="keyword">int</span> loadFactor)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Gossip</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Whether to automatically attempt to start a Gossip Routers. The host and port of the Gossip server</span></span><br><span class="line"><span class="comment">             * are taken from the first define host in 'hosts'.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">boolean</span> autoStart = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Defines the hosts of the Gossip Routers to connect to, in the form of host[port],...</span></span><br><span class="line"><span class="comment">             * &lt;p&gt;</span></span><br><span class="line"><span class="comment">             * If autoStart is set to &#123;<span class="doctag">@code</span> true&#125;, the first host and port are used as bind address and bind port</span></span><br><span class="line"><span class="comment">             * of the Gossip server to start.</span></span><br><span class="line"><span class="comment">             * &lt;p&gt;</span></span><br><span class="line"><span class="comment">             * Defaults to localhost[12001].</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">private</span> String hosts = <span class="string">"localhost[12001]"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAutoStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> autoStart;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAutoStart</span><span class="params">(<span class="keyword">boolean</span> autoStart)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.autoStart = autoStart;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getHosts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> hosts;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHosts</span><span class="params">(String hosts)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.hosts = hosts;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>可以看到我们只需在application.properties中添加<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">axon.distributed.jgroups.enabled=true</span><br><span class="line">axon.distributed.jgroups.gossip.autoStart=true</span><br></pre></td></tr></table></figure><p></p><p>就可以启用JGroupsConnector。同时也可以用前缀axon.distributed.jgroups加上<code>JGroupsProperties</code>里定义的各种field名来做JGroup的配置。（默认连接本地7800端口）<br>这里值得注意的是：</p><ol><li><code>JGroupsConnectorFactoryBean</code>实现的方法中，有一段<em>System.setProperty(“jgroups.tunnel.gossiprouterhosts”, jGroupsProperties.getGossip().getHosts());</em> ，如果axon.distributed.jgroups.gossip.autoStart未设为true(默认false)，那么getGossip()显然将会报空指针异常。</li><li><code>JacksonSerializer</code>的实现中，并未去考虑Jackson对Exception的处理(<strong>objectMapper.configure( DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false)</strong>)，导致一旦在Command执行时发生异常，DistributeCommandBus也会尝试把这个Exception消息进行序列化，而Jackson默认是无法处理java.lang.Throwable类的，就会发生序列化错误<em>org.codehaus.jackson.map.exc.UnrecognizedPropertyException: Unrecognized field “cause” (Class java.lang.Throwable), not marked as ignorable</em>，从而导致把真正的Exception给掩埋掉了。所以，这里我就改回默认的XStreamSerializer。</li><li>默认情况下，<code>localSegment</code>是SimpleCommandBus，所以参考前文，可以使用sendAndWait把异常抛到最前端处理，或者用send(command, callback)传入一个callback，在callback的onFailure方法对Throwable进行处理。</li></ol><h2 id="实现EventHandler的分布式调用"><a href="#实现EventHandler的分布式调用" class="headerlink" title="实现EventHandler的分布式调用"></a>实现EventHandler的分布式调用</h2><p>通常情况下，Event的分发我们第一时间想到的就是MQ，Axon也不例外，提供了对<a href="https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol" target="_blank" rel="noopener">AMQP</a>(Advanced Message Queuing Protocol)的支持，例如Rabbit MQ。<br>引入如下Maven依赖：<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.axonframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>axon-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.axonframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>axon-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>spring-boot-starter-amqp提供具体AMQP实现的服务，axon-amqp提供具体的Event分发机制实现，axon-spring-boot-autoconfigure提供AMQP的自动配置。<br>AxonAutoConfiguration中，关于AMQP部分的源码如下：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123;SpringAMQPPublisher.class, ConnectionFactory.class&#125;)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(AMQPProperties.class)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AMQPConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AMQPProperties amqpProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RoutingKeyResolver <span class="title">routingKeyResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PackageRoutingKeyResolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AMQPMessageConverter <span class="title">amqpMessageConverter</span><span class="params">(Serializer serializer, RoutingKeyResolver routingKeyResolver)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultAMQPMessageConverter(serializer, routingKeyResolver, amqpProperties.isDurableMessages());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConditionalOnProperty</span>(<span class="string">"axon.amqp.exchange"</span>)</span><br><span class="line">    <span class="meta">@Bean</span>(initMethod = <span class="string">"start"</span>, destroyMethod = <span class="string">"shutDown"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpringAMQPPublisher <span class="title">amqpBridge</span><span class="params">(EventBus eventBus, ConnectionFactory connectionFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          AMQPMessageConverter amqpMessageConverter)</span> </span>&#123;</span><br><span class="line">        SpringAMQPPublisher publisher = <span class="keyword">new</span> SpringAMQPPublisher(eventBus);</span><br><span class="line">        publisher.setExchangeName(amqpProperties.getExchange());</span><br><span class="line">        publisher.setConnectionFactory(connectionFactory);</span><br><span class="line">        publisher.setMessageConverter(amqpMessageConverter);</span><br><span class="line">        <span class="keyword">switch</span> (amqpProperties.getTransactionMode()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TRANSACTIONAL:</span><br><span class="line">                publisher.setTransactional(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PUBLISHER_ACK:</span><br><span class="line">                publisher.setWaitForPublisherAck(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NONE:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown transaction mode: "</span> + amqpProperties.getTransactionMode());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> publisher;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>可以看到，只要引入了Spring关于AMQP的starter包，我们只需要在application.properties中用<code>axon.amqp.exchange=Axon.EventBus</code>指明AMQP的exchange名字就可以启用了，非常方便。<br>另外就是需要给spring-boot-starter-amqp提供amqp具体实现的配置，这里我们以<a href="https://www.rabbitmq.com/" target="_blank" rel="noopener">RabbitMq</a>为例：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># mq</span><br><span class="line">spring.rabbitmq.host=10.1.110.21</span><br><span class="line">spring.rabbitmq.port=5672</span><br><span class="line">spring.rabbitmq.username=axon</span><br><span class="line">spring.rabbitmq.password=axon</span><br><span class="line">axon.amqp.exchange=Axon.EventBus</span><br></pre></td></tr></table></figure><p></p><p>RabbitMqServer的搭建我这里就不叙述了，网上一搜一大把。但为了方便理解，我还是简单介绍下AMQP和RabbitMq的一些关键要素。<br>首先看一下AMQP的”生产/消费”模型图<br><img src="/images/2017/04/producer_consumer.png" alt=""><br>我们关注里面的三个核心概念</p><ul><li><code>Exchange</code>: 交换器，message到达broker的第一站，根据分发策略，匹配查询表中的routing key，分发消息到queue中去。</li><li><code>Queue</code>：消息最终被送到这里等待consumer取走。一个message可以被同时拷贝到多个queue中。</li><li><code>Binding</code>：Exchange与Queue之间的绑定关系，指定了绑定策略，即消息的分发策略。<br>分发策略有以下四种：</li><li><code>direct</code><br><img src="/images/2017/04/direct_exchange.png" alt=""><br>“先匹配, 再投送”. 即在绑定时设定一个<code>routing_key</code>, 消息的<code>routing_key</code>匹配时, 才会被交换器投送到绑定的队列中去.</li><li><code>fanout</code><br><img src="/images/2017/04/fanout_exchange.png" alt=""><br>把消息转发给所有绑定的队列上, 就是一个”广播”行为.</li><li><code>topic</code><br><img src="/images/2017/04/topic_exchange.png" alt=""><br>与direct类似，只是绑定的<code>routing_key</code>支持匹配规则（并不是正则！），会把消息自己的<code>routing_key</code>与绑定的<code>routing_key</code>进行匹配操作，只把匹配成功的发到对应queue中。<br>这里有个“坑”，rabbit提供的*绑定一个任意字母，#绑定0个或多个字母匹配规则中，#并不能直接使用，比如#test#就无法匹配aatest33，必须要#.test.#才起作用，匹配aa.test.33，也是醉了。所以Axon默认提供的RoutingKey生成就是根据包名来匹配……</li><li><code>headers</code><br>不使用<code>routing_key</code>，而使用<code>headers</code>来做匹配。</li></ul><p>那么我们来对AMQP在代码中做exchange和queue的绑定，以及对event的listen动作。<br><code>AMQPConfiguration</code><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AMQPConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;axon.amqp.exchange&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> String exchangeName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Queue <span class="title">productQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">"product"</span>, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Queue <span class="title">orderQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">"order"</span>,<span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Exchange <span class="title">exchange</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> ExchangeBuilder.topicExchange(exchangeName).durable(<span class="keyword">true</span>).build();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Binding <span class="title">productQueueBinding</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> BindingBuilder.bind(productQueue()).to(exchange()).with(<span class="string">"#.product.#"</span>).noargs();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Binding <span class="title">orderQueueBinding</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> BindingBuilder.bind(orderQueue()).to(exchange()).with(<span class="string">"#.order.#"</span>).noargs();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*@Bean</span></span><br><span class="line"><span class="comment">  public SpringAMQPMessageSource productQueueMessageSource(Serializer serializer)&#123;</span></span><br><span class="line"><span class="comment">      return new SpringAMQPMessageSource(serializer)&#123;</span></span><br><span class="line"><span class="comment">          @RabbitListener(queues = "product")</span></span><br><span class="line"><span class="comment">          @Override</span></span><br><span class="line"><span class="comment">          public void onMessage(Message message, Channel channel) throws Exception &#123;</span></span><br><span class="line"><span class="comment">              LOGGER.debug("Product message received: "+message.toString());</span></span><br><span class="line"><span class="comment">              super.onMessage(message, channel);</span></span><br><span class="line"><span class="comment">          &#125;</span></span><br><span class="line"><span class="comment">      &#125;;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @Bean</span></span><br><span class="line"><span class="comment">  public SpringAMQPMessageSource orderQueueMessageSource(Serializer serializer)&#123;</span></span><br><span class="line"><span class="comment">      return new SpringAMQPMessageSource(serializer)&#123;</span></span><br><span class="line"><span class="comment">          @RabbitListener(queues = "order")</span></span><br><span class="line"><span class="comment">          @Override</span></span><br><span class="line"><span class="comment">          public void onMessage(Message message, Channel channel) throws Exception &#123;</span></span><br><span class="line"><span class="comment">              LOGGER.debug("Order message received: "+message.toString());</span></span><br><span class="line"><span class="comment">              super.onMessage(message, channel);</span></span><br><span class="line"><span class="comment">          &#125;</span></span><br><span class="line"><span class="comment">      &#125;;</span></span><br><span class="line"><span class="comment">  &#125;*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>注意，由于本例中，我并没有把Product和Order相关的Service拆分成两个应用，仍然在一个CommandSide中，所以其实我们根本用不到分布式EventHandler，local可以完成的操作，放到其他node去做，反而降低了性能。<br>所以，我这里并没有在CommandSide的这个<code>AMQPConfiguration</code>中去配置监听queue。这里的队列其实是CommandSide和QuerySide之间用的。<br>但配置和原理都是一样的，如果把Product和Order分开，<code>ProductReservedEvent</code>在ProductServcices所在节点扔到队列后，可按需配置绑定，让OrderService能够取到该事件，交给Saga中的EventHandler去处理。<br>在后面与SpringCloud集成的一文中，就会这样做。<br>QuerySide的<code>AMQPConfiguration</code>与上面一致，但是要打开被注释掉的部分。因为exchange和queue是自动创建的，有可能QuerySide先启动，所以必须要在QuerySide也加上exchange和queue的定义及绑定策略。<br><code>@RabbitListener(queues = &quot;product&quot;)</code>用来指定当前AMQPMessageSource要监听哪个queue。<br>同时，还需要修改application.properties，来绑定AMQPMessageSource和具体的EventHandler注册类<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">axon.eventhandling.processors.product.source=productQueueMessageSource</span><br><span class="line">axon.eventhandling.processors.order.source=orderQueueMessageSource</span><br></pre></td></tr></table></figure><p></p><p>axon.eventhandling.processors.[processors_group_name].source中，前面axon.eventhandling.processors.[processors_group_name]其实是一个ProcessingGroup，Axon提供了注解@ProcessingGroup(“[processors_group_name]”)来进行标识。<br>所以我们需要在QuerySide的<code>ProductEventHandler</code>和<code>OrderEventHandler</code>上面增加该注解<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ProcessingGroup</span>(<span class="string">"order"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderEventHandler</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ProcessingGroup</span>(<span class="string">"product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductEventHandler</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>为方便测试，我们来增加一个对Product库存进行调整的接口，这样可以启动两个CommandSide，同时对库存进行调整，看看会不会有并发问题。<br>同样，先定义Commmand和对应的Event：<br>ChangeStockCommand(productId, number)<br>IncreaseStockCommand extends ChangeStockCommand<br>DecreaseStockCommand extends ChangeStockCommand<br>IncreaseStockEvent(productId, number)<br>DecreaseStockEvent(productId, number)</p><p>修改<code>ProductAggregate</code>，增加对应的CommandHandler和EventHandler<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aggregate</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductAggregate</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CommandHandler</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(IncreaseStockCommand command)</span> </span>&#123;</span><br><span class="line">      apply(<span class="keyword">new</span> IncreaseStockEvent(command.getId(),command.getNumber()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CommandHandler</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(DecreaseStockCommand command)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(stock&gt;=command.getNumber())</span><br><span class="line">          apply(<span class="keyword">new</span> DecreaseStockEvent(command.getId(),command.getNumber()));</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> NoEnoughStockException(<span class="string">"No enough items"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@EventHandler</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">(IncreaseStockEvent event)</span></span>&#123;</span><br><span class="line">      stock = stock + event.getNumber();</span><br><span class="line">      LOGGER.info(<span class="string">"Product &#123;&#125; stock increase &#123;&#125;, current value: &#123;&#125;"</span>, id, event.getNumber(), stock);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@EventHandler</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">(DecreaseStockEvent event)</span></span>&#123;</span><br><span class="line">      stock = stock - event.getNumber();</span><br><span class="line">      LOGGER.info(<span class="string">"Product &#123;&#125; stock decrease &#123;&#125;, current value: &#123;&#125;"</span>, id, event.getNumber(), stock);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>最后对外增加一个REST接口：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductController</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="meta">@PutMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> String id,</span></span><br><span class="line"><span class="function">                     @<span class="title">RequestBody</span><span class="params">(required = <span class="keyword">true</span>)</span> JSONObject input,</span></span><br><span class="line"><span class="function">                     HttpServletResponse response)</span>&#123;</span><br><span class="line">      <span class="keyword">boolean</span> isIncrement = input.getBooleanValue(<span class="string">"incremental"</span>);</span><br><span class="line">      <span class="keyword">int</span> number = input.getIntValue(<span class="string">"number"</span>);</span><br><span class="line">      ChangeStockCommand command = isIncrement? <span class="keyword">new</span> IncreaseStockCommand(id, number) : <span class="keyword">new</span> DecreaseStockCommand(id, number);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// multiply 100 on the price to avoid float number</span></span><br><span class="line">          <span class="comment">//commandGateway.send(command, LoggingCallback.INSTANCE);</span></span><br><span class="line">          commandGateway.sendAndWait(command);</span><br><span class="line">          response.setStatus(HttpServletResponse.SC_OK);<span class="comment">// Set up the 201 CREATED response</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (CommandExecutionException cex) &#123;</span><br><span class="line">          LOGGER.warn(<span class="string">"Add Command FAILED with Message: &#123;&#125;"</span>, cex.getMessage());</span><br><span class="line">          response.setStatus(HttpServletResponse.SC_BAD_REQUEST);</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> != cex.getCause()) &#123;</span><br><span class="line">              LOGGER.warn(<span class="string">"Caused by: &#123;&#125; &#123;&#125;"</span>, cex.getCause().getClass().getName(), cex.getCause().getMessage());</span><br><span class="line">              <span class="keyword">if</span> (cex.getCause() <span class="keyword">instanceof</span> ConcurrencyException) &#123;</span><br><span class="line">                  LOGGER.warn(<span class="string">"Concurrent issue happens for product &#123;&#125;"</span>, id);</span><br><span class="line">                  response.setStatus(HttpServletResponse.SC_CONFLICT);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="comment">// should not happen</span></span><br><span class="line">          LOGGER.error(<span class="string">"Unexpected exception is thrown"</span>, e);</span><br><span class="line">          response.setStatus(HttpServletResponse.SC_BAD_REQUEST);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这里我用了sendAndWait，把Exception一路抛上来在Controller捕获。你也可以用我注掉的那段send(command,callback)，传入一个callback，在callback的onFailure方法去处理。<br>同样，QuerySide要对这两个事件进行处理<br><code>ProductEventHandler</code><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p>好，最后我们把CommandSide的server.port配成0（随机端口），启动两个CommandSide(假定一个端口为&lt;first_port&gt;，一个为&lt;second_port&gt;)和一个QuerySide。</p><ol><li>POST请求到<a href="http://127.0.0.1" target="_blank" rel="noopener">http://127.0.0.1</a>:&lt;first_port&gt;/product/1?name=ttt&amp;price=10&amp;stock=100 创建商品；</li><li>POST请求到<a href="http://127.0.0.1" target="_blank" rel="noopener">http://127.0.0.1</a>:&lt;second_port&gt;/product/1?name=ttt&amp;price=10&amp;stock=100 会发现报错，商品已存在；</li><li>GET请求到<a href="http://127.0.0.1:8080/product/1" target="_blank" rel="noopener">http://127.0.0.1:8080/product/1</a> 在QuerySide查看商品是否创建成功；</li><li><p>PUT如下json到<a href="http://127.0.0.1" target="_blank" rel="noopener">http://127.0.0.1</a>:&lt;first_port&gt;/product/1 来增加库存；</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"incremental"</span>:<span class="literal">true</span>,</span><br><span class="line">	<span class="attr">"number"</span>:<span class="number">10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>PUT如下json到<a href="http://127.0.0.1" target="_blank" rel="noopener">http://127.0.0.1</a>:&lt;second_port&gt;/product/1 来减少库存；</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"incremental"</span>:<span class="literal">false</span>,</span><br><span class="line">	<span class="attr">"number"</span>:<span class="number">101</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>重置MongoDB的库，同时发送3、4，看看结果。<br>其实我们如果去MongoDB的Events里面查看，数据如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.events.find().pretty()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="attr">"_id"</span> : ObjectId(<span class="string">"58ec4ef673bc0c1c188117b9"</span>),</span><br><span class="line">        <span class="attr">"aggregateIdentifier"</span> : <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"ProductAggregate"</span>,</span><br><span class="line">        <span class="attr">"sequenceNumber"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">        <span class="attr">"serializedPayload"</span> : <span class="string">"&lt;com.edi.learn.axon.events.product.ProductCreatedEvent&gt;&lt;id&gt;1&lt;/id&gt;&lt;name&gt;ttt&lt;/name&gt;&lt;price&gt;1000&lt;/price&gt;&lt;stock&gt;100&lt;/stock&gt;&lt;/com.edi.learn.axon.events.product.ProductCreatedEvent&gt;"</span>,</span><br><span class="line">        <span class="attr">"timestamp"</span> : <span class="string">"2017-04-11T03:35:18.310Z"</span>,</span><br><span class="line">        <span class="attr">"payloadType"</span> : <span class="string">"com.edi.learn.axon.events.product.ProductCreatedEvent"</span>,</span><br><span class="line">        <span class="attr">"payloadRevision"</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">"serializedMetaData"</span> : <span class="string">"&lt;meta-data&gt;&lt;entry&gt;&lt;string&gt;traceId&lt;/string&gt;&lt;string&gt;af292c24-bde4-4ba1-a190-9743822f839c&lt;/string&gt;&lt;/entry&gt;&lt;entry&gt;&lt;string&gt;correlationId&lt;/string&gt;&lt;string&gt;af292c24-bde4-4ba1-a190-9743822f839c&lt;/string&gt;&lt;/entry&gt;&lt;/meta-data&gt;"</span>,</span><br><span class="line">        <span class="attr">"eventIdentifier"</span> : <span class="string">"ed244ef3-a1fe-48fb-99b8-39ebd2444cc1"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="attr">"_id"</span> : ObjectId(<span class="string">"58ec4f0273bc0c1c188117ba"</span>),</span><br><span class="line">        <span class="attr">"aggregateIdentifier"</span> : <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"ProductAggregate"</span>,</span><br><span class="line">        <span class="attr">"sequenceNumber"</span> : NumberLong(<span class="number">1</span>),</span><br><span class="line">        <span class="attr">"serializedPayload"</span> : <span class="string">"&lt;com.edi.learn.axon.events.product.IncreaseStockEvent&gt;&lt;id&gt;1&lt;/id&gt;&lt;number&gt;10&lt;/number&gt;&lt;/com.edi.learn.axon.events.product.IncreaseStockEvent&gt;"</span>,</span><br><span class="line">        <span class="attr">"timestamp"</span> : <span class="string">"2017-04-11T03:35:30.728Z"</span>,</span><br><span class="line">        <span class="attr">"payloadType"</span> : <span class="string">"com.edi.learn.axon.events.product.IncreaseStockEvent"</span>,</span><br><span class="line">        <span class="attr">"payloadRevision"</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">"serializedMetaData"</span> : <span class="string">"&lt;meta-data&gt;&lt;entry&gt;&lt;string&gt;traceId&lt;/string&gt;&lt;string&gt;05252e0c-eb0b-4ed0-945c-0134fa94b6ba&lt;/string&gt;&lt;/entry&gt;&lt;entry&gt;&lt;string&gt;correlationId&lt;/string&gt;&lt;string&gt;05252e0c-eb0b-4ed0-945c-0134fa94b6ba&lt;/string&gt;&lt;/entry&gt;&lt;/meta-data&gt;"</span>,</span><br><span class="line">        <span class="attr">"eventIdentifier"</span> : <span class="string">"f6b9786d-4abd-4407-a40b-880f88738b4b"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="attr">"_id"</span> : ObjectId(<span class="string">"58ec4f0d73bc0c1ad83281d6"</span>),</span><br><span class="line">        <span class="attr">"aggregateIdentifier"</span> : <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"ProductAggregate"</span>,</span><br><span class="line">        <span class="attr">"sequenceNumber"</span> : NumberLong(<span class="number">2</span>),</span><br><span class="line">        <span class="attr">"serializedPayload"</span> : <span class="string">"&lt;com.edi.learn.axon.events.product.DecreaseStockEvent&gt;&lt;id&gt;1&lt;/id&gt;&lt;number&gt;101&lt;/number&gt;&lt;/com.edi.learn.axon.events.product.DecreaseStockEvent&gt;"</span>,</span><br><span class="line">        <span class="attr">"timestamp"</span> : <span class="string">"2017-04-11T03:35:41.474Z"</span>,</span><br><span class="line">        <span class="attr">"payloadType"</span> : <span class="string">"com.edi.learn.axon.events.product.DecreaseStockEvent"</span>,</span><br><span class="line">        <span class="attr">"payloadRevision"</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">"serializedMetaData"</span> : <span class="string">"&lt;meta-data&gt;&lt;entry&gt;&lt;string&gt;traceId&lt;/string&gt;&lt;string&gt;cf21b4a8-dfae-4da8-a6e0-964876c101c3&lt;/string&gt;&lt;/entry&gt;&lt;entry&gt;&lt;string&gt;correlationId&lt;/string&gt;&lt;string&gt;cf21b4a8-dfae-4da8-a6e0-964876c101c3&lt;/string&gt;&lt;/entry&gt;&lt;/meta-data&gt;"</span>,</span><br><span class="line">        <span class="attr">"eventIdentifier"</span> : <span class="string">"ac9db091-73fd-4830-9ddb-85fea3a13206"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>其实可以发现<code>sequenceNumber</code>一值是递增的，说明Event在分布式环境中也是严格按时间排序的。这样即便是在两个不同的CommandSide节点，当我们尝试去改变Aggregate的状态时，Axon会做ES来从Repository里获取当前Aggregate的最新状态，从而实现了原子性操作。</p><p>本文完整代码：<a href="https://github.com/EdisonXu/sbs-axon/tree/master/lesson-6" target="_blank" rel="noopener">https://github.com/EdisonXu/sbs-axon/tree/master/lesson-6</a></p><div class="article-copyright"><i class="fa fa-lightbulb-o"></i> 本文由 <a href="http://edisonxu.org/2017/04/01/axon-distribute.html">EdisonXu - 徐焱飞</a> 创作，采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 进行许可。 可自由转载、引用，但需署名作者且注明文章出处。本位链接为<a href="http://edisonxu.org/2017/04/01/axon-distribute.html" target="_blank" rel="external">http://edisonxu.org/2017/04/01/axon-distribute.html</a></div><div class="article-dashang"> <span>如果您觉得文章不错,可以请我喝一杯咖啡！</span><br><a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a><div id="dim-codes" hidden="hidden"><ul class="img_box_ul"><li><img src="/css/images/weixin.png"></li><li><img src="/css/images/zhifubao.png"></li></ul></div></div><script type="text/javascript">$("#btn_donate").click(function(){$("#dim-codes").toggle(300)})</script></div><footer class="article-footer"> <a href="http://edisonxu.org/2017/04/01/axon-distribute.html#comments" class="article-comment-link">评论</a><div class="share-container"><div class="bdsharebuttonbox"> <a href="#" class="bds_more" data-cmd="more">分享到：</a> <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a> <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a> <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a> <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a> <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a></div><script>with(window._bd_share_config={common:{bdSnsKey:{},bdText:"",bdMini:"2",bdMiniList:!1,bdPic:"",bdStyle:"0",bdSize:"16"},share:{bdSize:16}},document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)</script><style>.bdshare_popup_box{border-radius:4px;border:#e1e1e1 solid 1px}.bdshare-button-style0-16 .bds_more,.bdshare-button-style0-16 a{padding-left:20px;margin:6px 10px 6px 0}.bdshare_dialog_list a,.bdshare_popup_bottom a,.bdshare_popup_list a{font-family:'Microsoft Yahei'}.bdshare_popup_top{display:none}.bdshare_popup_bottom{height:auto;padding:5px}</style></div></footer></div><nav id="article-nav"> <a href="/2017/04/24/axon-spring-cloud.html" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">上一篇</strong><div class="article-nav-title"> CQRS和Event Sourcing系列（九）：AxonFramework与SpringCloud的整合</div></a> <a href="/2017/03/31/axon-saga.html" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">下一篇</strong><div class="article-nav-title">CQRS和Event Sourcing系列（七）：Saga的使用</div></a></nav></article><section id="comments"><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><div id="hot-news-wrap"></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">公告</h3><div class="widget"><div class="card-front animated col s12 m12 l8 offset-l2 fadeInUp"><p class="board"> 您好，您是第<span id="busuanzi_value_site_uv"></span>位访客<br> QQ：228831793<br> 微信：fei158383<br> 邮箱：edisonxu@outlook.com<br> CQRS&ES交流群：57241527<br><br> 欢迎交流与分享经验!</p></div></div></div><div class="widget-wrap"><h3 class="widget-title">归档</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">2</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签云</h3><div class="widget tagcloud"> <a href="/tags/CQRS/" style="font-size:20px">CQRS</a> <a href="/tags/DDD/" style="font-size:20px">DDD</a> <a href="/tags/JHipster/" style="font-size:10px">JHipster</a> <a href="/tags/SpringBoot/" style="font-size:10px">SpringBoot</a> <a href="/tags/actor/" style="font-size:13.33px">actor</a> <a href="/tags/akka/" style="font-size:16.67px">akka</a> <a href="/tags/axon/" style="font-size:20px">axon</a> <a href="/tags/eventsourcing/" style="font-size:20px">eventsourcing</a> <a href="/tags/eventuate/" style="font-size:10px">eventuate</a> <a href="/tags/多线程/" style="font-size:10px">多线程</a> <a href="/tags/并发/" style="font-size:13.33px">并发</a> <a href="/tags/并行/" style="font-size:10px">并行</a> <a href="/tags/微服务/" style="font-size:10px">微服务</a> <a href="/tags/感悟/" style="font-size:10px">感悟</a> <a href="/tags/杂项/" style="font-size:10px">杂项</a></div></div><div class="widget-wrap widget-list"><h3 class="widget-title">链接</h3><div class="widget"><ul><li> <a href="http://bbs.springcloud.cn">SpringCloud中文社区</a></li><li> <a href="http://www.spring4all.com">Spring For All社区</a></li><li> <a href="http://itmuch.com">周立|Spring Cloud</a></li><li> <a href="http://blog.didispace.com">程序猿DD</a></li><li> <a href="http://www.cnblogs.com/netfocus">汤雪华的博客</a></li><li> <a href="http://edisonxu.com">EdisonXu</a></li></ul></div></div><div id="toTop" class="fa fa-angle-up"></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"> &copy; 2018 Edison Xu<br> 本站总访问量<span id="busuanzi_value_site_pv"></span>次<br> <a href="http://www.miitbeian.gov.cn/publish/query/indexFirst.action" target="_blank">沪ICP备18006173号</a></div></div></footer><script>var cloudTieConfig={url:document.location.href,sourceId:"",productKey:"5b17b705ee04468c8699e7e4e10d97d6",target:"cloud-tie-wrapper"}</script><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var yunModuleEnv=!0</script><script>var yunTieProductKey="5b17b705ee04468c8699e7e4e10d97d6",yunHotNewsWrap="hot-news-wrap";Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vZXh0ZW5kL2hvdF9uZXdzX3NjcmlwdC5odG1s",!0)</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/vendor/lightgallery/js/lightgallery.min.js"></script><script src="/vendor/lightgallery/js/lg-thumbnail.min.js"></script><script src="/vendor/lightgallery/js/lg-pager.min.js"></script><script src="/vendor/lightgallery/js/lg-autoplay.min.js"></script><script src="/vendor/lightgallery/js/lg-fullscreen.min.js"></script><script src="/vendor/lightgallery/js/lg-zoom.min.js"></script><script src="/vendor/lightgallery/js/lg-hash.min.js"></script><script src="/vendor/lightgallery/js/lg-share.min.js"></script><script src="/vendor/lightgallery/js/lg-video.min.js"></script><script src="/js/main.js"></script></div></body></html>