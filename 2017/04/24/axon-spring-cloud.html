<!DOCTYPE html><html lang="zh"><head><meta http-equiv="refresh" content="0;url=http://edisonxu.com/2017/04/24/axon-spring-cloud.html"><meta charset="utf-8"><title>CQRS和Event Sourcing系列（九）：AxonFramework与SpringCloud的整合 | Edison Xu&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="上一篇里，我们在利用Axon3的DistributeCommand的JGroup支持，和DistributedEvent对AMQP的支持，实现了分布式环境下的CQRS和EventSourcing。在这一篇中，我们将把Axon3与当下比较火热的微服务框架——SpringCloud进行整合，并将其微服务化。  写在前面的话AxonFramework对SpringCloud的支持，是从3.0.2才开始"><meta name="keywords" content="CQRS,axon,DDD,eventsourcing"><meta property="og:type" content="article"><meta property="og:title" content="CQRS和Event Sourcing系列（九）：AxonFramework与SpringCloud的整合"><meta property="og:url" content="http://edisonxu.org/2017/04/24/axon-spring-cloud.html"><meta property="og:site_name" content="Edison Xu&#39;s Blog"><meta property="og:description" content="上一篇里，我们在利用Axon3的DistributeCommand的JGroup支持，和DistributedEvent对AMQP的支持，实现了分布式环境下的CQRS和EventSourcing。在这一篇中，我们将把Axon3与当下比较火热的微服务框架——SpringCloud进行整合，并将其微服务化。  写在前面的话AxonFramework对SpringCloud的支持，是从3.0.2才开始"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="http://edisonxu.org/images/2017/04/lesson7_archi.png"><meta property="og:updated_time" content="2018-02-23T02:20:25.478Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="CQRS和Event Sourcing系列（九）：AxonFramework与SpringCloud的整合"><meta name="twitter:description" content="上一篇里，我们在利用Axon3的DistributeCommand的JGroup支持，和DistributedEvent对AMQP的支持，实现了分布式环境下的CQRS和EventSourcing。在这一篇中，我们将把Axon3与当下比较火热的微服务框架——SpringCloud进行整合，并将其微服务化。  写在前面的话AxonFramework对SpringCloud的支持，是从3.0.2才开始"><meta name="twitter:image" content="http://edisonxu.org/images/2017/04/lesson7_archi.png"><link rel="alternate" href="/atom.xml" title="Edison Xu&#39;s Blog" type="application/atom+xml"><link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/vendor/open-sans/styles.css"><link rel="stylesheet" href="/vendor/source-code-pro/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/vendor/jquery/2.1.3/jquery.min.js"></script><link rel="stylesheet" href="/vendor/lightgallery/css/lightgallery.min.css"></head><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><i class="logo"></i> <span class="site-title">Edison Xu&#39;s Blog</span></a><nav id="main-nav"> <a class="main-nav-link" href="/.">主页</a> <a class="main-nav-link" href="/archives">目录</a> <a class="main-nav-link" href="http://blog.csdn.net/xeseo">旧站</a> <a class="main-nav-link" href="/about">关于我</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"> <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/e8022ebe2f6f01924ccded8d4db8b9fa"><i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form class="search-form"> <input type="text" class="ins-search-input search-form-input" placeholder="搜索"> <button type="submit" class="search-form-submit"></button></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"> <input type="text" class="ins-search-input" placeholder="想要查找什么..."><span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script></div></div></div><div id="main-nav-mobile" class="header-sub header-inner"><table class="menu outer"><tr><td><a class="main-nav-link" href="/.">主页</a></td><td><a class="main-nav-link" href="/archives">目录</a></td><td><a class="main-nav-link" href="http://blog.csdn.net/xeseo">旧站</a></td><td><a class="main-nav-link" href="/about">关于我</a></td><td><div class="search-form"> <input type="text" class="ins-search-input search-form-input" placeholder="搜索"></div></td></tr></table></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"> <img id="avatar" src="https://www.gravatar.com/avatar/e8022ebe2f6f01924ccded8d4db8b9fa?s=128"><h2 id="name">Edison Xu</h2><h3 id="title">懂得前端和移动，设计过架构，做过管理，也搞过自动化和运维，明白各种测试，知晓处理大数据。保持危机感和谦逊，方能更进一步</h3><span id="location"><i class="fa fa-map-marker"></i> 中国 - 上海</span> <a id="follow" target="_blank" href="http://edisonxu.com/about">关注我</a></div><div class="article-info profile-block"><div class="article-info-block"> 13 <span>文章</span></div><div class="article-info-block"> 12 <span>标签</span></div></div><div class="profile-block social-links"><table><tr><td><a href="https://github.com/EdisonXu" target="_blank" title="github" class="tooltip"><i class="fa fa-github"></i></a></td><td><a href="mailto:edisonxu@outlook.com" target="_blank" title="envelope" class="tooltip"><i class="fa fa-envelope"></i></a></td><td><a href="/css/images/myweixin.jpg" target="_blank" title="weixin" class="tooltip"><i class="fa fa-weixin"></i></a></td><td><a href="/atom.xml" target="_blank" title="rss" class="tooltip"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-axon-spring-cloud" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name"> CQRS和Event Sourcing系列（九）：AxonFramework与SpringCloud的整合</h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2017/04/24/axon-spring-cloud.html"><time datetime="2017-04-24T07:01:51.000Z" itemprop="datePublished">2017-04-24</time></a></div><i class="fa fa-tag"></i> <a class="tag-link" href="/tags/CQRS/">CQRS</a>, <a class="tag-link" href="/tags/DDD/">DDD</a>, <a class="tag-link" href="/tags/axon/">axon</a>, <a class="tag-link" href="/tags/eventsourcing/">eventsourcing</a><span id="busuanzi_container_site_pv" style="display:none;float:right"><i class="fa fa-eye" aria-hidden="true" style="margin-right:5px"></i><span id="busuanzi_value_page_pv"></span> 人阅读</span></div></header><div class="article-entry" itemprop="articleBody"><blockquote><p>上一篇里，我们在利用Axon3的DistributeCommand的JGroup支持，和DistributedEvent对AMQP的支持，实现了分布式环境下的CQRS和EventSourcing。<br>在这一篇中，我们将把Axon3与当下比较火热的微服务框架——SpringCloud进行整合，并将其微服务化。</p></blockquote><h6 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h6><p>AxonFramework对SpringCloud的支持，是从3.0.2才开始的，但是在3.0.2和3.0.3两个版本，均存在blocking bug，<strong>所以要想与SpringCloud完成整合，版本必须大于等于3.0.4</strong>。<br>PS：连续跳坑，debug读代码，帮Axon找BUG，血泪换来的结论……好在社区足够活跃，作者也比较给力，连续更新。</p><h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>按照微服务的概念，我们把Product和Order各自相关的功能单独抽出来各做出一个服务，即product-service和order-service。与上一篇不同，这里并没有把各自service的command端和query端单独拆成一个service，而是放在一起了。当然，你也可以自行把他们拆开，中间通过mq传递消息。<br>具体架构如下：<br><img src="/images/2017/04/lesson7_archi.png" alt=""></p><h2 id="前置工作"><a href="#前置工作" class="headerlink" title="前置工作"></a>前置工作</h2><p>首先，我们在父pom中配置好与SpringCloud集成相关的公共Maven依赖。</p><ul><li>对SpringBoot的依赖 (这一块前面我们已经配置过了，这里可以跳过)</li><li>对SpringCloud的依赖</li><li>对具体SpringCloud组件的依赖</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>common-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>config-service<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>discovery-service<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>proxy-service<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>product-service<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>order-service<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Camden.SR6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Cloud Features --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="SpringCloud组件"><a href="#SpringCloud组件" class="headerlink" title="SpringCloud组件"></a>SpringCloud组件</h2><p>熟悉SpringCloud的朋友，可以直接跳过本章。</p><h3 id="Discovery-Serivce"><a href="#Discovery-Serivce" class="headerlink" title="Discovery Serivce"></a>Discovery Serivce</h3><p>使用SpringCloud中的Eureka组件，实现服务注册和发现。各个服务本身把自己注册到Eureka上，Proxy Service使用的zuul，在配置了Eureka相关信息后，会自动从Eureka中发现对应服务名及其地址，与配置文件中进行匹配，从而实现动态路由。<br>同时Eureka提供的UI也可以很直观的对服务当前的状态进行监控。<br>使用Eureka非常简单，引入Maven依赖<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>然后在SpringBootApplication的类申明上加上<code>@EnableEurekaServer</code>注解即可。<br>对应配置文件如下：<br></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configure this Discovery Server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    lease-expiration-duration-in-seconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    lease-renewal-interval-in-seconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">  client:</span> <span class="comment">#Not a client, don't register with yourself</span></span><br><span class="line"><span class="attr">    registerWithEureka:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    healthcheck:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  server:</span></span><br><span class="line"><span class="attr">      enable-self-preservation:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">endpoints:</span></span><br><span class="line"><span class="attr"> shutdown:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">1111</span> <span class="comment">#HTTP(Tomcat) port</span></span><br></pre></td></tr></table></figure><p></p><p>没什么花样，只是申明自己不是EurekaClient，而是Server。<br>Eureka有一个自我保护机制关闭，默认打开的情况下，当注册的service”挂掉”后，Eureka短时间内并不会直接把它从列表内清除，而是保留一段时间。因为Eureka的设计者认为分布式环境中网络是不可靠的，也许因为网络的原因，Eureka Server没有收到实例的心跳，但并不说命实例就完蛋了，所以这种机制下，它仍然鼓励客户端再去尝试调用这个所谓DOWN状态的实例，如果确实调用失败了，断路器机制还可以派上用场。这里我们方便起见，直接使用server.enable-self-preservation设置为false关闭掉它。（生产别这么用）</p><h3 id="Proxy-Service"><a href="#Proxy-Service" class="headerlink" title="Proxy Service"></a>Proxy Service</h3><p>使用SpringCloud中的zuul组件。具体作用有：</p><ul><li>全局网关，屏蔽内部系统和网络</li><li>请求拦截和动态路由</li><li>请求负载均衡<br>zuul的使用配置非常简单，引入Maven依赖<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>然后在SpringBootApplication类申明上加上<code>@EnableZuulProxy</code>和<code>@EnableDiscoveryClient</code>注解即可。<code>@EnableDiscoveryClient</code>是把Proxy Service注册到Eureka上。<br>对应配置文件如下：<br></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">proxy-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line">      <span class="string">discovery.enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="string">discovery.serviceId:</span> <span class="string">config-service</span></span><br><span class="line"><span class="attr">      failFast:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Discovery Server Access</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://$&#123;config.host:10.1.110.21&#125;:1111/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  ignoredServices:</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    product_command_path:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/product/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">product-service</span></span><br><span class="line"><span class="attr">    product_query_path:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/products/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">product-service</span></span><br><span class="line"><span class="attr">    order-command_path:</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">order-service</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/order/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    order_query_path:</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">order-service</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/orders/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p></p><p><code>spring.application.name</code> 属性指定服务名<br><code>spring.cloud.config</code> 相关的是配置ConfigService去Eureka上找serviceId为<code>config-service</code>的服务<br><code>eureka.client.serviceUrl.defaultZone</code> 配置要注册的Eureka的地址<br><code>ignoredServices</code>设为<em>，即不转发除了下面<code>routes</code>以外的所有请求<br><code>routes.&lt;xxx&gt;.path</code> 是映射xxx服务与URL地址<br><code>routes.&lt;xxx&gt;.stripPrefix</code> 是不使用前缀，即将<a href="http://product/" target="_blank" rel="noopener">http://product/</a></em> 请求直接转发到product-service。如果设置了前缀，那么合法路径则变为http://<prefix>/product/* 。<br><code>routes.&lt;xxx&gt;.serviceId</code> 即Eureka上xxx服务所注册的服务名，zuul从Eureka上找到该服务名所对应的服务器信息，从而实现动态路由。<br>这里为了演示zuul对不同路径映射到相同服务，我故意把command和query端的URL地址设为不同，如/product和/products。</prefix></p><h3 id="Cloud-Configs-Service"><a href="#Cloud-Configs-Service" class="headerlink" title="Cloud Configs Service"></a>Cloud Configs Service</h3><p>使用SpringCloud中的Cloud组件，实现统一文件配置。（未引入SpringCloudBus实现配置修改通知，可自行修改添加。）<br>一样，引入Maven依赖<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>在SpringBootApplication的类声明前加上<code>@EnableConfigServer</code>和<code>@EnableDiscoveryClient</code>注解。<code>@EnableDiscoveryClient</code>是把Config Service注册到Eureka上。<br>SpringCloudConfig最大的好处，可以从git读取配置，给不同环境、不同zone设置不同分支，根据profile指定分支，非常方便。<br>在这里为了方便各位自己跑，我把Config Service配置为读取本地文件。<br></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># Active reading config from local file system</span></span><br><span class="line"><span class="attr">  profiles:</span></span><br><span class="line"><span class="attr">    active:</span> <span class="string">native</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">config-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        native:</span></span><br><span class="line"><span class="attr">          searchLocations:</span> <span class="string">/usr/edi/spring/configs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  context-path:</span> <span class="string">/admin</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:1111/eureka/</span></span><br></pre></td></tr></table></figure><p></p><h2 id="业务服务"><a href="#业务服务" class="headerlink" title="业务服务"></a>业务服务</h2><p>在前一篇<a href="http://edisonxu.com/2017/04/01/axon-distribute.html" target="_blank" rel="noopener">CQRS和Event Souring系列（八）：DistributeCommand和DistributeEvent</a> 中提到过，DistributedCommandBus不会直接调用command handler，它只是在不同JVM的commandbus之间建立一个“桥梁”，通过指定<code>CommandRouter</code>和<code>CommandBusConnector</code>进行Command的分发。<code>axon-distributed-commandbus-springcloud</code>包提供了SpringCloud环境下的<code>CommandRouter</code>和<code>CommandBusConnector</code>。<br><strong><em>CommandRouter</em></strong><br><code>SpringCloudCommandRouter</code>是该包中<code>CommandRouter</code>的具体实现类，其实是调用了我们在SpringBootApplication中<code>@EnableDiscoveryClient</code>后注入的EurekaClient。<br>每一个Axon的command节点在启动时，会通过DiscoveryClient把本地所有的CommandHandler变向的塞入本地服务在Eureka上的metadata信息中。当DistributedCommandBus发送command时，通过DiscoveryClient从Eureka上获取所有节点信息后，找到metadata中的CommandHandler的信息进行command匹配，分发到匹配的节点去处理command。</p><p><strong><em>CommandBusConnector</em></strong><br><code>SpringHttpCommandBusConnector</code>是<code>CommandBusConnector</code>的具体实现类，它其实在本地起了一个地址为”/spring-command-bus-connector”的REST接口，用以接受来自其他节点的command请求。<br>同时，它也覆写了方法<code>CommandBusConnector</code>中的send方法，用以发送command到经<code>CommandRouter</code>确认的目标地址。当然，它会先判断目标地址是否本地，如果是本地，则直接调用localCommandBus去处理了，否则，则使用RestTemplate将Command发送到远程地址。</p><p>所以，启用Axon对SpringCloud的支持，必须要有三步（引入<code>axon-spring-boot-autoconfigure</code>的前提下）：</p><ol><li>引入<code>axon-distributed-commandbus-springcloud</code>包依赖；</li><li>配置文件中<code>axon.distributed.enabled</code>设置为true;</li><li>在自己的配置类中提供一个名字为<code>restTemplate</code>的Bean，返回一个RestTemplate的对象；</li></ol><p><strong>注意！</strong><br>目前不能在RestTemplate声明时加上@LoadBalance启用Ribbon做负载均衡，因为<code>SpringHttpCommandBusConnector</code>在发送远程command时，会根据Eureka返回的目标Server信息自己build URI，URI中直接使用了ip/hostname，而不是service name。一旦用@LoadBalance，那么请求将被拦截生成RibbonHttpRequest,该Request在执行时会把传入的URI当做service name去与DiscoveryClient取到的所有service的service name匹配，最终会找不到目标节点，而报java.lang.IllegalStateException: No instances available for 10.1.110.21 。 这里10.1.110.21即是前面<code>SpringHttpCommandBusConnector</code>自己从DiscoveryClient那已经解析出来的ip。</p><h3 id="Product-Serivce"><a href="#Product-Serivce" class="headerlink" title="Product Serivce"></a>Product Serivce</h3><p>核心代码与上一篇并无大区别，依然是CQRS，C端采用JPA将Event持久化到Mysql，而Q端将数据保存在MongoDB，方便查询（好吧，这仅仅是为了show一下怎么样在C、Q端使用不同的持久层而已，存Event的话，MongoDB比MySql适合的多）。这里只把不同地方中关键的列出来说一下，详细请查阅代码。<br><em><strong>pom依赖</strong></em><br>引入<code>axon-distributed-commandbus-springcloud</code>包依赖<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.axonframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>axon-distributed-commandbus-springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;axon.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p><code>AMQPConfiguration</code><br>配置AMQP协议的mq绑定，用于把Event分发到mq中，最终由Order Service的OrderSaga去处理。Product Serivce本身不消费Order Service所产生的Event，本地的EventHandle并不会走MQ。详细配置这里就省略了，可以参见上一篇文章或者看具体代码。</p><p><code>CloudConfiguration</code><br>这个类啥都不干，只是创建一个restTemplate的实例<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>启动类<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;<span class="string">"com.edi.learn"</span>&#125;)</span><br><span class="line"><span class="meta">@EnableJpaRepositories</span>(basePackages = &#123;<span class="string">"com.edi.learn.cloud.command"</span>&#125;)</span><br><span class="line"><span class="meta">@EnableMongoRepositories</span>(basePackages = &#123;<span class="string">"com.edi.learn.cloud.query"</span>&#125;)</span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span>()</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>配置文件的修改上面已经提过了，这里就不再重复。</p><h3 id="Order-Serivce"><a href="#Order-Serivce" class="headerlink" title="Order Serivce"></a>Order Serivce</h3><p>就启用SpringCloud来说，与上面没有任何区别。为了让OrderSaga能正常收到并处理来自于prodcut-service的事件，必须要进行额外配置。前一篇文章中提到的<code>@ProcessGroup</code>，并不适用于Saga，同时，Axon3中，目前对于Saga处理distributed event并不是很友好，3.0.4以前，Saga只能支持绑定一个EventStore，但是分布式情况下，一个service可能要监听多个queue，所以3.0.4中，支持了自定义Saga配置，即可以声明一个&lt;saga_name&gt;+SagaConfiguration作为Bean名，并返回SagaConfiguration类型的Bean。为了让Saga能处理来自于外部MQ的事件，我们必须提供一个orderSagaConfiguration。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SpringAMQPMessageSource <span class="title">queueMessageSource</span><span class="params">(Serializer serializer)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SpringAMQPMessageSource(serializer)&#123;</span><br><span class="line">        <span class="meta">@RabbitListener</span>(queues = <span class="string">"orderqueue"</span>)</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="meta">@Transactional</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            LOGGER.debug(<span class="string">"Message received: "</span>+message.toString());</span><br><span class="line">            <span class="keyword">super</span>.onMessage(message, channel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SagaConfiguration&lt;OrderSaga&gt; <span class="title">orderSagaConfiguration</span><span class="params">(Serializer serializer)</span></span>&#123;</span><br><span class="line">    SagaConfiguration&lt;OrderSaga&gt; sagaConfiguration = SagaConfiguration.subscribingSagaManager(OrderSaga.class, c-&gt; queueMessageSource(serializer));</span><br><span class="line">    <span class="comment">//sagaConfiguration.registerHandlerInterceptor(c-&gt;transactionManagingInterceptor());</span></span><br><span class="line">    <span class="keyword">return</span> sagaConfiguration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TransactionManagingInterceptor <span class="title">transactionManagingInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TransactionManagingInterceptor(<span class="keyword">new</span> SpringTransactionManager(transactionManager));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>如上面代码，自行指定Saga的message source，这样来自于product-service写入mq的ProductReservedEvent等事件就能被Saga正确处理。<br>这里要注意的是事务问题，由于我们是通过MQ的onMessage来启动具体的SagaCommandHandler，上下文中并未定义事务特性，但是由于我们引入了Spring的jpa包，axon3的auto configuration会自动启用SagaJpaRepository，也就是说，onMessage方法线程执行时，会牵扯到DB的更新，必须得给它指定一个transaction manager。这里有两种方法：</p><ol><li>使用@Transactional 注解，让Spring自行配置；</li><li>在SagaConfiguration中注册TransactionManagingInterceptor。</li></ol><p>另外，由于在创建订单时，只传了Product的Id，根据id去查询当前product的最新详情，需要请求Product Service的query端。这个query端我们是用<code>spring-boot-starter-data-rest</code>直接暴露出去的<a href="https://en.wikipedia.org/wiki/HATEOAS" target="_blank" rel="noopener">HATEOAS</a>(Hypermedia as the Engine of Application State)风格的RESTFul接口。即是说，要做一个跨服务的REST请求，且要支持HATEOAS，那么我们就使用<a href="https://github.com/OpenFeign/feign" target="_blank" rel="noopener">Feign</a>加上<code>spring-boot-starter-hateoas</code>。</p><ol><li><p>更新pom</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-feign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-hateoas<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在order-service中添加一个Feign Client</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"product-service"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/products"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function">Resources&lt;ProductDto&gt; <span class="title">getProducts</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/products/&#123;id&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function">ProductDto <span class="title">getProduct</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String productId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在SpringBootApplication中启用FeignClient和HypermediaSupport</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;<span class="string">"com.edi.learn"</span>&#125;)</span><br><span class="line"><span class="meta">@EnableJpaRepositories</span>(basePackages = &#123;<span class="string">"com.edi.learn.cloud.command"</span>&#125;)</span><br><span class="line"><span class="meta">@EnableMongoRepositories</span>(basePackages = &#123;<span class="string">"com.edi.learn.cloud.query"</span>&#125;)</span><br><span class="line"><span class="meta">@EnableFeignClients</span>(basePackages = &#123;<span class="string">"com.edi.learn.cloud.common.web"</span>&#125;)</span><br><span class="line"><span class="meta">@EnableHypermediaSupport</span>(type = EnableHypermediaSupport.HypermediaType.HAL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>ProductDto都是封装属性的POJO，就不写了。这样我们就可以在代码中直接注入ProductService，并调用相应方法从product-service端取数据了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，Axon3与SpringCloud的集成已完毕。Axon3使用SpringCloud提供的服务注册和发现机制，来进行Command的分发和处理。具体运行情况我就不写了，大家可自行修改order-service的配置，去跑多个order-service。留个悬念，由于是同一段代码和配置，mq我们使用fanout，即分发的模式，所有节点都会收到ProductReservedEvent，是否所有节点都会处理呢？</p><h6 id="写在后面的话"><a href="#写在后面的话" class="headerlink" title="写在后面的话"></a>写在后面的话</h6><p>截止到本篇，Axon3使用的大部分功能都已经做了入门介绍，并写了例子，作为研究，算是入门了,尤其是文档中没有说明的一些关键地方，我都在文中提了出来。掉过不少坑，看了很多源码， 回头看来，我对Axon3的设计是肯定与失望并存。<br>肯定的是Axon3的易用性与性能，尤其是DisruptorCommandBus配合CachingGenericEventSourcingRepository（采用了LMAX的<a href="https://lmax-exchange.github.io/disruptor/" target="_blank" rel="noopener">Disruptor框架</a>，可以看下一篇比较早的文章介绍，猛击<a href="http://blog.trifork.com/2011/07/20/processing-1m-tps-with-axon-framework-and-the-disruptor/" target="_blank" rel="noopener">这里</a>或<a href="http://ifeve.com/axon/" target="_blank" rel="noopener">中文翻译版</a>）;<br>失望的是Axon3更多的优化和针对都集中在单体应用上，对分布式和微服务的集成稍显简单，例如负载均衡的支持、容错性的支持等，目前尚未看到介绍。<br>当然，这块现在也才刚刚起步，后续应该会变得越来越好。原期望于Axon3直接把这块做掉或者提供支持，现在看来是否我想太多，这块本就不该它做呢？欢迎加群57241527讨论。</p><p>照例，本文源码：<a href="https://github.com/EdisonXu/sbs-axon/tree/master/lesson-7" target="_blank" rel="noopener">https://github.com/EdisonXu/sbs-axon/tree/master/lesson-7</a></p><div class="article-copyright"><i class="fa fa-lightbulb-o"></i> 本文由 <a href="http://edisonxu.org/2017/04/24/axon-spring-cloud.html">EdisonXu - 徐焱飞</a> 创作，采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 进行许可。 可自由转载、引用，但需署名作者且注明文章出处。本位链接为<a href="http://edisonxu.org/2017/04/24/axon-spring-cloud.html" target="_blank" rel="external">http://edisonxu.org/2017/04/24/axon-spring-cloud.html</a></div><div class="article-dashang"> <span>如果您觉得文章不错,可以请我喝一杯咖啡！</span><br><a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a><div id="dim-codes" hidden="hidden"><ul class="img_box_ul"><li><img src="/css/images/weixin.png"></li><li><img src="/css/images/zhifubao.png"></li></ul></div></div><script type="text/javascript">$("#btn_donate").click(function(){$("#dim-codes").toggle(300)})</script></div><footer class="article-footer"> <a href="http://edisonxu.org/2017/04/24/axon-spring-cloud.html#comments" class="article-comment-link">评论</a><div class="share-container"><div class="bdsharebuttonbox"> <a href="#" class="bds_more" data-cmd="more">分享到：</a> <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a> <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a> <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a> <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a> <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a></div><script>with(window._bd_share_config={common:{bdSnsKey:{},bdText:"",bdMini:"2",bdMiniList:!1,bdPic:"",bdStyle:"0",bdSize:"16"},share:{bdSize:16}},document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)</script><style>.bdshare_popup_box{border-radius:4px;border:#e1e1e1 solid 1px}.bdshare-button-style0-16 .bds_more,.bdshare-button-style0-16 a{padding-left:20px;margin:6px 10px 6px 0}.bdshare_dialog_list a,.bdshare_popup_bottom a,.bdshare_popup_list a{font-family:'Microsoft Yahei'}.bdshare_popup_top{display:none}.bdshare_popup_bottom{height:auto;padding:5px}</style></div></footer></div><nav id="article-nav"> <a href="/2018/02/01/jhipster-quick-start.html" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">上一篇</strong><div class="article-nav-title"> JHipster快速开发Web应用</div></a> <a href="/2017/04/01/axon-distribute.html" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">下一篇</strong><div class="article-nav-title">CQRS和Event Sourcing系列（八）：DistributeCommand和DistributeEvent</div></a></nav></article><section id="comments"><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><div id="hot-news-wrap"></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">公告</h3><div class="widget"><div class="card-front animated col s12 m12 l8 offset-l2 fadeInUp"><p class="board"> 您好，您是第<span id="busuanzi_value_site_uv"></span>位访客<br> QQ：228831793<br> 微信：fei158383<br> 邮箱：edisonxu@outlook.com<br> CQRS&ES交流群：57241527<br><br> 欢迎交流与分享经验!</p></div></div></div><div class="widget-wrap"><h3 class="widget-title">归档</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">2</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签云</h3><div class="widget tagcloud"> <a href="/tags/CQRS/" style="font-size:20px">CQRS</a> <a href="/tags/DDD/" style="font-size:20px">DDD</a> <a href="/tags/JHipster/" style="font-size:10px">JHipster</a> <a href="/tags/SpringBoot/" style="font-size:10px">SpringBoot</a> <a href="/tags/akka/" style="font-size:10px">akka</a> <a href="/tags/axon/" style="font-size:20px">axon</a> <a href="/tags/eventsourcing/" style="font-size:20px">eventsourcing</a> <a href="/tags/eventuate/" style="font-size:10px">eventuate</a> <a href="/tags/多线程/" style="font-size:10px">多线程</a> <a href="/tags/微服务/" style="font-size:10px">微服务</a> <a href="/tags/感悟/" style="font-size:10px">感悟</a> <a href="/tags/杂项/" style="font-size:10px">杂项</a></div></div><div class="widget-wrap widget-list"><h3 class="widget-title">链接</h3><div class="widget"><ul><li> <a href="http://bbs.springcloud.cn">SpringCloud中文社区</a></li><li> <a href="http://www.spring4all.com">Spring For All社区</a></li><li> <a href="http://itmuch.com">周立|Spring Cloud</a></li><li> <a href="http://blog.didispace.com">程序猿DD</a></li><li> <a href="https://www.bysocket.com">泥瓦匠BYSocket</a></li><li> <a href="http://edisonxu.com">EdisonXu</a></li></ul></div></div><div id="toTop" class="fa fa-angle-up"></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"> &copy; 2018 Edison Xu<br> 本站总访问量<span id="busuanzi_value_site_pv"></span>次<br> <a href="http://www.miitbeian.gov.cn/publish/query/indexFirst.action" target="_blank">沪ICP备18006173号</a></div></div></footer><script>var cloudTieConfig={url:document.location.href,sourceId:"",productKey:"5b17b705ee04468c8699e7e4e10d97d6",target:"cloud-tie-wrapper"}</script><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var yunModuleEnv=!0</script><script>var yunTieProductKey="5b17b705ee04468c8699e7e4e10d97d6",yunHotNewsWrap="hot-news-wrap";Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vZXh0ZW5kL2hvdF9uZXdzX3NjcmlwdC5odG1s",!0)</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/vendor/lightgallery/js/lightgallery.min.js"></script><script src="/vendor/lightgallery/js/lg-thumbnail.min.js"></script><script src="/vendor/lightgallery/js/lg-pager.min.js"></script><script src="/vendor/lightgallery/js/lg-autoplay.min.js"></script><script src="/vendor/lightgallery/js/lg-fullscreen.min.js"></script><script src="/vendor/lightgallery/js/lg-zoom.min.js"></script><script src="/vendor/lightgallery/js/lg-hash.min.js"></script><script src="/vendor/lightgallery/js/lg-share.min.js"></script><script src="/vendor/lightgallery/js/lg-video.min.js"></script><script src="/js/main.js"></script></div></body></html>